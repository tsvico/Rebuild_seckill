# å¼€å‘ç¬”è®°
------
[TOC]

# å‰è¨€

ç§’æ€ç³»ç»Ÿä¸»è¦åº”ç”¨åœ¨å•†å“æŠ¢è´­çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼š

- å¤©çŒ«æ·˜å®åŒåä¸€æŠ¢è´­é™é‡å•†å“
- å°ç±³æ‰‹æœºæŠ¢è´­
- å–çƒ­é—¨æ¼”å”±ä¼šçš„é—¨ç¥¨
- ç«è½¦ç¥¨æŠ¢åº§
- â€¦

ç§’æ€ç³»ç»ŸæŠ½è±¡æ¥è¯´å°±æ˜¯ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

- ç”¨æˆ·é€‰å®šå•†å“ä¸‹å•
- æ ¡éªŒåº“å­˜
- æ‰£åº“å­˜
- åˆ›å»ºç”¨æˆ·è®¢å•
- â€¦

æ‰€è°“â€œç§’æ€â€,å°±æ˜¯ç½‘ç»œå–å®¶å‘å¸ƒä¸€-äº›è¶…ä½ä»·æ ¼çš„å•†å“,.æ‰€æœ‰ä¹°å®¶åœ¨åŒ-æ—¶é—´ç½‘ä¸ŠæŠ¢è´­çš„ä¸€ç§é”€å”®æ–¹å¼

- ä½ä»·ï¼Œå°‘é‡åº“å­˜ï¼Œç–¯æŠ¢
- é«˜å¹¶å‘ï¼Œå¤§æµé‡

## ä¸ºä»€ä¹ˆè¦åšæ‰€è°“çš„â€œç³»ç»Ÿâ€

å¦‚æœä½ çš„é¡¹ç›®æµé‡éå¸¸å°ï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒæœ‰å¹¶å‘çš„è´­ä¹°è¯·æ±‚ï¼Œé‚£ä¹ˆåšè¿™æ ·ä¸€ä¸ªç³»ç»Ÿæ„ä¹‰ä¸å¤§ã€‚

ä½†å¦‚æœä½ çš„ç³»ç»Ÿè¦åƒ12306é‚£æ ·ï¼Œæ¥å—é«˜å¹¶å‘è®¿é—®å’Œä¸‹å•çš„è€ƒéªŒï¼Œé‚£ä¹ˆä½ å°±éœ€è¦ä¸€å¥—å®Œæ•´çš„**æµç¨‹ä¿æŠ¤æªæ–½**ï¼Œæ¥ä¿è¯ä½ ç³»ç»Ÿåœ¨ç”¨æˆ·æµé‡é«˜å³°æœŸä¸ä¼šè¢«ææŒ‚äº†ã€‚ï¼ˆå°±åƒ12306åˆšå¼€å§‹ç½‘ç»œå”®ç¥¨é‚£å‡ å¹´ä¸€æ ·ï¼‰

è¿™äº›æªæ–½æœ‰ä»€ä¹ˆå‘¢ï¼š

- ä¸¥æ ¼é˜²æ­¢è¶…å–ï¼šåº“å­˜100ä»¶ä½ å–äº†120ä»¶ï¼Œç¨‹åºå‘˜èƒŒé”…ï¼Œæˆ˜å£«ä¸Šæˆ˜åœºï¼Œè¿™ç‚¹å°äº‹éƒ½å¹²ä¸å¥½ï¼Œç­‰ç€è¢«è¾é€€å§
- é˜²æ­¢éæ³•è¯·æ±‚ï¼šé˜²æ­¢ä¸æ€€å¥½æ„çš„äººç¾¤é€šè¿‡å„ç§æŠ€æœ¯æ‰‹æ®µä»¥è¾ƒä½çš„ç§’æ€ä»·æ ¼å¤§é‡ä¸‹å•ã€‚
- ä¿è¯ç”¨æˆ·ä½“éªŒï¼šé«˜å¹¶å‘ä¸‹ï¼Œåˆ«ç½‘é¡µæ‰“ä¸å¼€äº†ï¼Œæ”¯ä»˜ä¸æˆåŠŸäº†ï¼Œè´­ç‰©è½¦è¿›ä¸å»äº†ï¼Œåœ°å€æ”¹ä¸äº†äº†ã€‚ç³»ç»Ÿç›´æ¥å´©æºƒï¼Œä½“éªŒå·®çš„ä¸€æ‰¹ã€‚è¿™ä¸ªé—®é¢˜éå¸¸ä¹‹å¤§ï¼Œæ¶‰åŠåˆ°å„ç§æŠ€æœ¯ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸‹å­å°±èƒ½è®²å®Œçš„ï¼Œç”šè‡³æ ¹æœ¬å°±æ²¡æ³•è®²å®Œã€‚

#  ğŸ”ªå¤§çº²ï¼ˆæŠ€æœ¯æ¦‚è¦ï¼‰

- springBoot å•ä½“æ¶æ„+å¾®æœåŠ¡åŒç‰ˆæœ¬

- ä¸ä»…ä»…æ˜¯ç§’æ€ï¼Œé«˜å¹¶å‘ä¸šåŠ¡åœºæ™¯å¦‚ä½•åº”å¯¹
- æŠ€æœ¯ç‚¹ï¼ˆå‰åç«¯åˆ†ç¦»(è¾ƒç®€å•ï¼Œä¸»è¦å®ç°ä¼˜åŒ–ç§’æ€)ï¼‰
    - å‰ç«¯
        - ~~Thymeleaf~~ã€layuiã€ Jquery ã€vue
    - åç«¯
        - SpringBootã€JSR303 æœåŠ¡ç«¯éªŒè¯æ¡†æ¶ï¼ŒåšæœåŠ¡ç«¯å‚æ•°æ ¡éªŒã€MyBatisã€SpringCloud Alibabaã€Dubbo
    - ä¸­é—´ä»¶
        - RabbitMQ  æ¶ˆæ¯é˜Ÿåˆ—
        - Redis  ç¼“å­˜
        - Druid  é˜¿é‡Œå¼€å‘è¿æ¥æ± ï¼Œå¯ä»¥ç›‘æ§
    
- å¤§çº²
    - åˆ†å¸ƒå¼ä¼šè¯ã€å•†å“åˆ—è¡¨é¡µã€å•†å“è¯¦æƒ…é¡µã€è®¢å•è¯¦æƒ…é¡µã€ç³»ç»Ÿå‹æµ‹ã€ç¼“å­˜ä¼˜åŒ–
    - æ¶ˆæ¯é˜Ÿåˆ—ã€æ¥å£å®‰å…¨
- åº”å¯¹å¤§å¹¶å‘
    - ç¼“å­˜ã€å¼‚æ­¥ã€ä¼˜é›…ä»£ç 
- ä»£ç é”™è¯¯è®°å½•ä»¥åŠè§£æ–¹æ¡ˆ
- å¸¸è§é—®é¢˜åˆ†æ

## ç›®å½•

[TOC]



- é¡¹ç›®æ¡†æ¶æ­å»º
    - SpringBootç¯å¢ƒæ­å»º
    - é›†æˆ~~Thymeleaf~~,Resultç»“æœå°è£…
    - é›†æˆMybatis+Druid
    - é›†æˆJedis+Rediså®‰è£…+é€šç”¨Keyå°è£…
    
- ç™»å½•
    - æ•°æ®åº“è®¾è®¡
    - æ˜æ–‡å¯†ç ä¸¤æ¬¡MD5+åŠ ç›
    - JSR303å‚æ•°æ£€éªŒ+å…¨å±€å¼‚å¸¸å¤„ç†
    - åˆ†å¸ƒå¼Session /JWTæ— çŠ¶æ€ç™»å½•
    
- åå°

- ç§’æ€åŠŸèƒ½
    - æ•°æ®åº“è®¾è®¡
    - å•†å“åˆ—è¡¨é¡µ
    - å•†å“è¯¦æƒ…é¡µ
    - è®¢å•è¯¦æƒ…é¡µ
    
- JMeterå‹æµ‹
  
    - æ¨¡æ‹Ÿå¤šç”¨æˆ·
    
- é¡µé¢ä¼˜åŒ–
    - é¡µé¢ç¼“å­˜ã€URLç¼“å­˜ã€å¯¹è±¡ç¼“å­˜
    - é¡µé¢é™æ€åŒ–ï¼Œå‰åç«¯åˆ†ç¦»
    - é™æ€èµ„æºä¼˜åŒ–
    - CDNä¼˜åŒ–
    
- æ¥å£ä¼˜åŒ–
    - Redisé¢„å‡åº“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
    - å†…å­˜æ ‡è®°å‡å°‘Redisè®¿é—®
    - RabbitMQé˜Ÿåˆ—ç¼“å†²ï¼Œå¼‚æ­¥ä¸‹å•ï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒ
    - è®¿é—®Nginxä¹¦è¯„æ‹“å±•
    - å‹æµ‹
    
- å®‰å…¨ä¼˜åŒ–
    - ç§’æ€æ¥å£åœ°å€éšè—
    - æ•°å­¦å…¬å¼éªŒè¯ç (å‰Šå³°)
    - æ¥å£é˜²åˆ·
    
    ### çƒ­éƒ¨ç½²
    
    ```xml
    <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-devtools</artifactId>
       <!-- optional=true, ä¾èµ–ä¸ä¼šä¼ é€’, è¯¥é¡¹ç›®ä¾èµ–devtools; ä¹‹åä¾èµ–booté¡¹ç›®çš„é¡¹ç›®å¦‚æœæƒ³è¦ä½¿ç”¨devtools, éœ€è¦é‡æ–°å¼•å…¥ -->
       <optional>true</optional>
    </dependency>
    ```
    
    ## æ¶æ„å›¾ å€Ÿé‰´https://github.com/qiurunze123/miaosha
    
    ![æ•´ä½“æµç¨‹](images/ç¬”è®°/miaosha.png)
    
    > æœªæ¥è®¾è®¡å›¾ : æœªæ¥è®¾è®¡ 
    
    ![æ•´ä½“æµç¨‹](images/ç¬”è®°/miaoshafuture.png)
    
    > mysql æ•°æ®åº“è¡¨è®¾è®¡
    
    ![æ•´ä½“æµç¨‹](images/ç¬”è®°/miaoshasql.png)
    
    
    
    

# ğŸ±â€ğŸå‡†å¤‡å·¥ä½œ

## jsonæ ¼å¼å°è£… Result.java

```json
{
    "code": 500100,
    "msg": "åº“å­˜ä¸è¶³",
    "data":{},[]
}
```

```java
public class Result<T> {
    private int code;
    private String msg;
    //ä¸æ¸…æ¥šçš„ç±»å‹ï¼Œå®šä¹‰ä¸ºæ³›å‹
    private T data;
    /**
     * æˆåŠŸæ—¶è°ƒç”¨
     *
     * @param data æ•°æ®
     * @param <T>
     * @return
     */
    public static <T> Result<T> success(T data) {
        return new Result<>(data);
    }
    /**
     * é”™è¯¯æ—¶è°ƒç”¨
     *
     * @param cm
     * @param <T>
     * @return
     */
    public static <T> Result<T> error(CodeMsg cm) {
        return new Result<T>(cm);
    }
    //...get set ...
}
```

- é”™è¯¯ç CodeMsg.java

```java
public class CodeMsg {
    private int code;
    private String msg;
    private  CodeMsg(int code, String msg) {
        this.code = code;
        this.msg = msg;
    }
    //é€šç”¨å¼‚å¸¸
    public static CodeMsg SUCCESS = new CodeMsg(0,"success");
    public static CodeMsg SERVER_ERROR = new CodeMsg(500100,"æœåŠ¡ç«¯å¼‚å¸¸");
    //ç™»å½•æ¨¡å—å¼‚å¸¸ 500200
    //å•†å“æ¨¡å— 500300
    //...
}
```

```properties
#è®¾ç½®nullçš„å±æ€§å€¼ä¸æ˜¾ç¤ºï¼Œæ¯”å¦‚é€šè¿‡jsonè¿”å›Userçš„æ—¶å€™ï¼Œå¯†ç è¦è®¾ç½®ä¸ºnull
spring.jackson.default-property-inclusion=non_null
```



## ~~thymeleaf(å¼ƒç”¨ï¼Œæ”¹ç”¨å‰åç«¯åˆ†ç¦»)~~

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```

- æ–‡ä»¶é…ç½®

    ```properties
    # thymeleaf
    spring.thymeleaf.cache=false
    ```

## mybatis

```xml
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.1.1</version>
</dependency>
<!--æ•°æ®åº“-->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <scope>runtime</scope>
</dependency>
```

```properties
# mybatis
# å®ä½“ç±»åŒ…è·¯å¾„
mybatis.type-aliases-package=cn.peoplevip.miaosha.domain
#ä¸‹åˆ’çº¿è½¬é©¼å³°
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.default-fetch-size=100
mybatis.configuration.default-statement-timeout=3000
# é…ç½®æ–‡ä»¶æ‰«æè·¯å¾„
mybatis.mapper-locations=classpath:cn/peoplevip/miaosha/dao/*.xml
```

## druid

```xml
<!--druid-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.1.21</version>
</dependency>
```

- é…ç½®æ–‡ä»¶

```properties
#druid
spring.datasource.type: com.alibaba.druid.pool.DruidDataSource
spring.datasource.url=jdbc:mysql://localhost:3306/miaosha?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8&useSSL=true
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
# åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§è¿æ¥æ•°
spring.datasource.druid.initial-size=3
spring.datasource.druid.min-idle=3
spring.datasource.druid.max-active=10

# é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´
spring.datasource.druid.max-wait=60000

# ç›‘æ§åå°è´¦å·å’Œå¯†ç 
spring.datasource.druid.stat-view-servlet.login-username=admin
spring.datasource.druid.stat-view-servlet.login-password=admin
#æ˜¯å¦å¯ç”¨StatViewServletï¼ˆç›‘æ§é¡µé¢ï¼‰é»˜è®¤å€¼ä¸ºfalse
spring.datasource.druid.stat-view-servlet.enabled=false

# é…ç½® StatFilter
spring.datasource.druid.filter.stat.log-slow-sql=true
spring.datasource.druid.filter.stat.slow-sql-millis=2000
```

## Redis

```xml
<dependency>
    <groupId>redis.clients</groupId>
    <artifactId>jedis</artifactId>
</dependency>

```

### é…ç½®

```properties
# redis
redis.host=127.0.0.1
redis.port=6379
redis.timeout=3
redis.password=
redis.poolMaxTotal=10
redis.poolMaxldle=10
#æœ€å¤§ç­‰å¾…
redis.poolMaxWait=3
```

### é…ç½®æ¥æ”¶

```java
@Component
@ConfigurationProperties(prefix = "redis")
public class RedisConfig {
    private String host;
    private int port;
    //ç§’
    private int timeout;
    private String password;
    private int poolMaxTotal;
    private int poolMaxldle;
    private int poolMaxWait;
    //get set
}
```



### åºåˆ—åŒ–å·¥å…·

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.62</version>
</dependency>
<!--æˆ–è€…(è°·æ­Œè¿™ä¸ªåºåˆ—åŒ–å·¥å…·ç»“æœä¸ºäºŒè¿›åˆ¶ï¼Œæ€§èƒ½æ›´é«˜)-->
 <dependency>
     <groupId>com.dyuproject.protostuff</groupId>
     <artifactId>protostuff-core</artifactId>
     <version>1.0.8</version>
</dependency>
<dependency>
    <groupId>com.dyuproject.protostuff</groupId>
    <artifactId>protostuff-runtime</artifactId>
    <version>1.0.8</version>
</dependency>
```

Spring Booté…ç½®æ³¨è§£æ‰§è¡Œå™¨   å½“æ‰§è¡Œç±»ä¸­å·²ç»å®šä¹‰äº†å¯¹è±¡å’Œè¯¥å¯¹è±¡çš„å­—æ®µåï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹è¯¥ç±»èµ‹å€¼æ—¶ï¼Œä¾¿ä¼šéå¸¸æ–¹ä¾¿çš„å¼¹å‡ºæç¤ºä¿¡æ¯

```xml
<!--é…ç½®æ³¨è§£æ‰§è¡Œå™¨(ä¸é…ç½®ä¸å½±å“è¿è¡Œ)-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-configuration-processor</artifactId>
    <optional>true</optional>
</dependency>
```

```java
//ä»£ç ç‰‡æ®µ
 //åŸå­æ“ä½œ  æ­£å¸¸è¿”å›okï¼Œé”™è¯¯è¿”å›é”™è¯¯ä¿¡æ¯
return jedis.setex(key, redisConfig.getTimeout() * 1000, str);
//åºåˆ—åŒ–æ“ä½œç±»
public class ProtostuffUtil {
    /**
     * åºåˆ—åŒ–
     */
    public static <T> byte[] serializer(T t){
        Schema schema = RuntimeSchema.getSchema(t.getClass());
        return ProtostuffIOUtil.toByteArray(t,schema,
                LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));
    }
    /**
     * ååºåˆ—åŒ–
     */
    public static <T> T deserializer(byte []bytes,Class<T> c) {
        if (bytes == null) {
            return null;
        }
        T t = null;
        try {
            t = c.newInstance();
            Schema schema = RuntimeSchema.getSchema(t.getClass());
            ProtostuffIOUtil.mergeFrom(bytes,t,schema);
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        return t;
    }
}
```

### ç¼“å­˜å°è£…

- é€šç”¨å°è£…ï¼ˆæ¨¡æ¿æ¨¡å¼ï¼‰

    <img src="images/ç¬”è®°/1582595289708.png" width=30%></img>
    
    å®šä¹‰é€šç”¨å‰ç¼€ç±»ï¼Œä»¥æ­¤é¢„é˜²å­˜å‚¨ä¸ä¼šè¢«å‹¿è¦†ç›–
    
    å®šä¹‰seviceç±» [RedisService](RedisService.md)
    
    è¿™é‡Œåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª
    
    ```properties
    #rediså­˜å‚¨æ–¹å¼æ˜¯å­—ç¬¦è¿˜æ˜¯äºŒè¿›åˆ¶ï¼Œå‚æ•°å¯é€‰ stringã€byte
    redis.StorageType=string
    ```
    
    æ¥è¿›è¡Œå…¨å±€ä½¿ç”¨å“ªç§æ–¹æ³•
    
    ```java
    // åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Šæ³¨è§£@PostConstructï¼Œè¿™æ ·æ–¹æ³•å°±ä¼šåœ¨Beanåˆå§‹åŒ–ä¹‹åè¢«Springå®¹å™¨æ‰§è¡Œï¼ˆæ³¨ï¼šBeanåˆå§‹åŒ–åŒ…æ‹¬ï¼Œå®ä¾‹åŒ–Beanï¼Œå¹¶è£…é…Beançš„å±æ€§ï¼ˆä¾èµ–æ³¨å…¥ï¼‰ï¼‰
    @PostConstruct
    public void init() {
        //trueä¸ºstringæ–¹å¼å­˜å‚¨ï¼Œfalseä¸ºbyte[]æ–¹å¼å­˜å‚¨
        redisStorage_type = "string".contains(redisConfig.getStorageType());
    }
    è¿™æ ·å°±ä¸ä¼šæŠ¥ç©ºå¼•ç”¨äº†ï¼Œåœ¨Serviceä¸­è°ƒç”¨å…¶ä»–æ•°æ®æ—¶
    ```

# ğŸ·ç™»å½•ä¸åˆ†å¸ƒå¼session/JWT

## æ•°æ®åº“è®¾è®¡

```sql

```



## å¯†ç åŠ å¯†

1. ç”¨æˆ·ç«¯: PASS = MD5 (æ˜æ–‡+å›ºå®šSalt)
2. æœåŠ¡ç«¯:PASS = MD5 (ç”¨æˆ·è¾“å…¥+éšæœºSalt)

```java
import org.springframework.util.DigestUtils;
//ä½¿ç”¨ç°æˆçš„MD5å·¥å…·ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…

//ç›ï¼Œç”¨äºæ··äº¤md5
private static String salt = "asdwqAsd12_qS";
/**
 * ç”Ÿæˆmd5
 * @param str
 * @return
 */
public static String getMD5(String str) {
    String base = str + "/" + salt;
    String md5 = DigestUtils.md5DigestAsHex(base.getBytes());
    return md5;
}
```



## JSR303å‚æ•°æ ¡éªŒ+ å…¨å±€å¼‚å¸¸å¤„ç†å™¨

- è‡ªå®šä¹‰å‚æ•°æ ¡éªŒ(åŸå§‹æ–¹æ³•)

    > åˆ›å»ºæ ¡éªŒç±»ï¼Œåˆ›å»ºå‚æ•°æ¥å—ç±»


### jsr303æ ¡éªŒ

```xml
<!--å¼•å…¥ä¾èµ–--> 
<dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

æ–°å¢è‡ªå®šä¹‰éªŒè¯å™¨



### å…¨å±€å¼‚å¸¸æ‹¦æˆªå™¨

ç™»å½•æ—¶å¦‚æœå¯†ç é”™è¯¯æˆ–è€…æ— è¯¥ç”¨æˆ·ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸æ‹¦æˆªå™¨ï¼Œè¿”å›å¼‚å¸¸ä¿¡æ¯

```java

/**
å…¨å±€å¼‚å¸¸æ‹¦æˆªå™¨
 */
@ControllerAdvice
@ResponseBody
public class GlobleExceptionHandler {
    /**
     * æ‰€æœ‰å¼‚å¸¸éƒ½æ‹¦æˆª
     */
    @ExceptionHandler(value = Exception.class)
    public Result<String> exceptionHandler(HttpServletRequest request, Exception e) {
        //æ‰“å°å¼‚å¸¸
        e.printStackTrace();
        //ç»‘å®šå¼‚å¸¸
        if (e instanceof GlobleException) {
            GlobleException ex = (GlobleException) e;
            return Result.error(ex.getCodeMsg());

        } else if (e instanceof BindException) {
            BindException ex = (BindException) e;
            List<ObjectError> errors = ex.getAllErrors();
            StringBuilder msg = new StringBuilder(10);
            for (ObjectError error : errors) {
                msg.append(error.getDefaultMessage()).append("\n");
            }
            return Result.error(CodeMsg.BIND_ERROR.fillArgs(msg.toString()));
        } else {
            return Result.error(CodeMsg.SERVER_ERROR);
        }
    }
}

//å¯†ç é”™è¯¯å¼‚å¸¸
throw new GlobleException(CodeMsg.PASSWORD_ERROR);
public class GlobleException extends RuntimeException {
    private static final long serialVersionUID = 1L;
    private CodeMsg codeMsg;
    public GlobleException(CodeMsg codeMsg) {
        super(codeMsg.toString());
        this.codeMsg = codeMsg;
    }
    public static long getSerialVersionUID() {
        return serialVersionUID;
    }
    public CodeMsg getCodeMsg() {
        return codeMsg;
    }
}
```



## åˆ†å¸ƒå¼Sessionå’ŒJWT

### é›ªèŠ±ç®—æ³•(snowflake)å”¯ä¸€UUID

snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚è¿™ç§æ–¹æ¡ˆå¤§è‡´æ¥è¯´æ˜¯ä¸€ç§ä»¥åˆ’åˆ†å‘½åç©ºé—´ï¼ˆUUIDä¹Ÿç®—ï¼Œç”±äºæ¯”è¾ƒå¸¸è§ï¼Œæ‰€ä»¥å•ç‹¬åˆ†æï¼‰æ¥ç”ŸæˆIDçš„ä¸€ç§ç®—æ³•ï¼Œè¿™ç§æ–¹æ¡ˆæŠŠ64-bitåˆ†åˆ«åˆ’åˆ†æˆå¤šæ®µï¼Œåˆ†å¼€æ¥æ ‡ç¤ºæœºå™¨ã€æ—¶é—´ç­‰ã€‚
å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0ã€‚

 ![img](images/ç¬”è®°/20191009093154467.png)

æ•´ä¸ªç»“æ„æ˜¯64ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨Javaä¸­å¯ä»¥ä½¿ç”¨longæ¥è¿›è¡Œå­˜å‚¨ã€‚ è¯¥ç®—æ³•å®ç°åŸºæœ¬å°±æ˜¯äºŒè¿›åˆ¶æ“ä½œ,å•æœºæ¯ç§’å†…ç†è®ºä¸Šæœ€å¤šå¯ä»¥ç”Ÿæˆ1024*(2^12)ï¼Œä¹Ÿå°±æ˜¯409.6ä¸‡ä¸ªID(1024 X 4096 = 4194304)

>   0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000 
>
>   1ä½æ ‡è¯†ï¼Œç”±äºlongåŸºæœ¬ç±»å‹åœ¨Javaä¸­æ˜¯å¸¦ç¬¦å·çš„ï¼Œæœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯0ï¼Œè´Ÿæ•°æ˜¯1ï¼Œæ‰€ä»¥idä¸€èˆ¬æ˜¯æ­£æ•°ï¼Œæœ€é«˜ä½æ˜¯0
>   41ä½æ—¶é—´æˆª(æ¯«ç§’çº§)ï¼Œæ³¨æ„ï¼Œ41ä½æ—¶é—´æˆªä¸æ˜¯å­˜å‚¨å½“å‰æ—¶é—´çš„æ—¶é—´æˆªï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆªçš„å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆª - å¼€å§‹æ—¶é—´æˆª) å¾—åˆ°çš„å€¼ï¼‰ï¼Œè¿™é‡Œçš„çš„å¼€å§‹æ—¶é—´æˆªï¼Œä¸€èˆ¬æ˜¯æˆ‘ä»¬çš„idç”Ÿæˆå™¨å¼€å§‹ä½¿ç”¨çš„æ—¶é—´ï¼Œç”±æˆ‘ä»¬ç¨‹åºæ¥æŒ‡å®šçš„ï¼ˆå¦‚ä¸‹ä¸‹é¢ç¨‹åºIdWorkerç±»çš„startTimeå±æ€§ï¼‰ã€‚41ä½çš„æ—¶é—´æˆªï¼Œå¯ä»¥ä½¿ç”¨69å¹´ï¼Œå¹´T = (1L << 41) / (1000L * 60 * 60 * 24 * 365) = 69
>   10ä½çš„æ•°æ®æœºå™¨ä½ï¼Œå¯ä»¥éƒ¨ç½²åœ¨1024ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬5ä½datacenterIdå’Œ5ä½workerIdã€‚10-bitæœºå™¨å¯ä»¥åˆ†åˆ«è¡¨ç¤º1024å°æœºå™¨ã€‚å¦‚æœæˆ‘ä»¬å¯¹IDCåˆ’åˆ†æœ‰éœ€æ±‚ï¼Œè¿˜å¯ä»¥å°†10-bitåˆ†5-bitç»™IDCï¼Œåˆ†5-bitç»™å·¥ä½œæœºå™¨ã€‚è¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ï¼Œå¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚å®šä¹‰ã€‚
>  12ä½åºåˆ—ï¼Œæ¯«ç§’å†…çš„è®¡æ•°ï¼Œ12ä½çš„è®¡æ•°é¡ºåºå·æ”¯æŒæ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’(åŒä¸€æœºå™¨ï¼ŒåŒä¸€æ—¶é—´æˆª)äº§ç”Ÿ4096ä¸ªIDåºå·ã€‚12ä¸ªè‡ªå¢åºåˆ—å·å¯ä»¥è¡¨ç¤º2^12ä¸ªIDï¼Œç†è®ºä¸Šsnowflakeæ–¹æ¡ˆçš„QPSçº¦ä¸º409.6w/sï¼Œè¿™ç§åˆ†é…æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä»»ä½•ä¸€ä¸ªIDCçš„ä»»ä½•ä¸€å°æœºå™¨åœ¨ä»»æ„æ¯«ç§’å†…ç”Ÿæˆçš„IDéƒ½æ˜¯ä¸åŒçš„ã€‚
>  åŠ èµ·æ¥åˆšå¥½64ä½ï¼Œä¸ºä¸€ä¸ªLongå‹ã€‚

**ä¼˜ç‚¹ï¼š**
æ•´ä½“ä¸ŠæŒ‰ç…§æ—¶é—´è‡ªå¢æ’åºï¼Œå¹¶ä¸”æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”ŸIDç¢°æ’(ç”±æ•°æ®ä¸­å¿ƒIDå’Œæœºå™¨IDä½œåŒºåˆ†)ï¼Œå¹¶ä¸”æ•ˆç‡è¾ƒé«˜ï¼Œç»æµ‹è¯•ï¼ŒSnowFlakeæ¯ç§’èƒ½å¤Ÿäº§ç”Ÿ26ä¸‡IDå·¦å³ã€‚

> æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚
> ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚
> å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚

**ç¼ºç‚¹ï¼š**

> å¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚
> é’ˆå¯¹æ­¤ï¼Œç¾å›¢åšå‡ºäº†æ”¹è¿›ï¼šhttps://github.com/Meituan-Dianping/Leaf

### ç±»æ‹¦æˆªå™¨è·å–User

```java
@Service
public class UserArgumentResolver implements HandlerMethodArgumentResolver {
      @Autowired
    MiaoshaUserService userService;
    @Override
    public boolean supportsParameter(MethodParameter methodParameter) {
        Class<?> clazz = methodParameter.getParameterType();
        return clazz == MiaoshaUser.class;
    }
    /** æå‰æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶æŠŠtokenè½¬åŒ–ä¸ºç±»å¯¹è±¡*/
    @Override
    public Object resolveArgument(MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer,
                                  NativeWebRequest nativeWebRequest,
                                  WebDataBinderFactory webDataBinderFactory) throws Exception {
        HttpServletResponse response = nativeWebRequest.getNativeResponse(HttpServletResponse.class);
        HttpServletRequest request = nativeWebRequest.getNativeRequest(HttpServletRequest.class);

        //ä»è¯·æ±‚å‚æ•°ä¸­å–å‡ºæ•°æ®,ä¾‹å¦‚è¡¨å•
        String ParamToken = request.getParameter(MiaoshaUserService.COOKI_NAME_TOKEN);
        //ä»cookieä¸­å–å‡ºæ•°æ®
        String cookieToken = getCookieValue(request, MiaoshaUserService.COOKI_NAME_TOKEN);
        //ä»headerä¸­å–å‡ºæ•°æ®
        String headerToken = request.getHeader(MiaoshaUserService.COOKI_NAME_TOKEN);

        if (StringUtils.isEmpty(cookieToken) && StringUtils.isEmpty(ParamToken) && StringUtils.isEmpty(headerToken)) {
            return null;
        }
        //ä¼˜å…ˆçº§ header > cookies > å‚æ•°
        String token = StringUtils.isEmpty(headerToken) ? cookieToken : headerToken;
        if (StringUtils.isEmpty(token)){
            token = ParamToken;
        }
        //å–å‡ºcookieï¼Œä¾èµ–tokenæ¥è·å–ç™»å½•çŠ¶æ€
        MiaoshaUser user = userService.getByToken(token,response);
        return user;
    }

    private String getCookieValue(HttpServletRequest request, String cookiNameToken) {
        Cookie[] cookies = request.getCookies();
        for (Cookie cookie: cookies){
            if (cookie.getName().equals(cookiNameToken)){
                return cookie.getValue();
            }
        }
        return null;
    }
}

//ä¸Šæ–¹è·å–çš„è¯·æ±‚æ•°æ®Userå¯ä»¥ç›´æ¥ä½¿ç”¨,è¿™æ ·å°±ä¸ç”¨æ¯ä¸ªéœ€è¦è·å–Userçš„æ§åˆ¶å™¨é‡æ–°å†™ä¸€éé‡å¤ä»£ç 
 @GetMapping("/to_list")
public String goods(Model model,MiaoshaUser user) {
    if (user == null) {
        return "redirect:/login";
    }
    model.addAttribute("user", user);
    return "goods_list";
}
```

### åˆ†å¸ƒå¼sessionå’ŒJWTæ¯”è¾ƒ

#### ä»€ä¹ˆæ˜¯session

é¦–å…ˆèŠèŠsessionå’Œcookieï¼Œsessionå¯¹è±¡å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯èŠ‚ç‚¹å†…å­˜ä¸­ï¼Œcookieå­˜å‚¨åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­ã€‚ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç«¯ç”Ÿæˆsessionå¯¹è±¡ï¼Œå°†sessionå¯¹è±¡å­˜å‚¨åœ¨jvmå†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨å“åº”å¤´ä¸­æ”¾å…¥sessionIdå“åº”ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°å“åº”åï¼Œå°†sessionidå­˜å‚¨åœ¨æœ¬åœ°ã€‚å½“æµè§ˆå™¨ç¬¬äºŒæ¬¡è¯·æ±‚æ—¶ä¼šå°†æœ¬åœ°cookieä¸­å­˜å‚¨çš„seesionIdé€šè¿‡è¯·æ±‚å¤´çš„æ–¹å¼ä¼ é€’ç»™æœåŠ¡å™¨ï¼Œè¿™æ ·æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å°±èƒ½ä¿æŒä¼šè¯ä¿¡æ¯ã€‚

é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°åˆ†å¸ƒå¼sessioné—®é¢˜å‘¢ï¼Œä¸ºäº†æé«˜æœåŠ¡å™¨ç«¯çš„è´Ÿè½½èƒ½åŠ›ï¼Œåå°ä¸€èˆ¬å°†æœåŠ¡å™¨èŠ‚ç‚¹åšé›†ç¾¤ï¼Œé€šè¿‡ngnixé€šè¿‡è½®è¯¢çš„æ–¹å¼è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œå½“æµè§ˆå™¨é¦–æ¬¡è®¿é—®AæœåŠ¡å™¨ç”Ÿæˆsessionå¯¹è±¡ï¼Œç„¶ååœ¨è®¿é—®ç”Ÿæˆçš„sessionå¯¹è±¡ï¼Œå¦‚æœæ­£å¥½è¢«ngnixè½¬å‘åˆ°äº†AæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæ²¡é—®é¢˜å¯ä»¥è·å–åˆ°sessionå¯¹è±¡ï¼Œå¦‚æœä¸å·§è¯·æ±‚è¢«è½¬å‘åˆ°BæœåŠ¡å™¨ï¼Œç”±äºä¹‹å‰ç”Ÿæˆçš„sessionå¯¹è±¡åœ¨AæœåŠ¡å™¨ï¼ŒBæœåŠ¡å™¨æ ¹æœ¬æ²¡æœ‰ç”Ÿæˆsessionå¯¹è±¡ï¼Œå¾ˆè‡ªç„¶è®¿é—®ä¸åˆ°sessionå¯¹è±¡ã€‚

çŸ¥é“äº†é—®é¢˜çš„å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§£å†³äº†ï¼Œå¯ä»¥é€šè¿‡tokenä»¤ç‰Œä»£æ›¿sessionè§£å†³ï¼Œæˆ–è€…é‡‡ç”¨spring-sessionè§£å†³ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©åä¸€ç§æ–¹å¼ï¼Œå…¶å®è§£å†³æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚åˆ†å¸ƒå¼sessionä¸èƒ½å…±äº«æ˜¯ç”±äºsessionå¯¹è±¡å­˜å‚¨åœ¨jvmå†…å­˜ä¸­ï¼Œé‚£ä¹ˆå¦‚æœå…±äº«ï¼Œç­”æ¡ˆæ˜¯å°†sessionæ”¾å…¥redisä¸­å­˜åœ¨ï¼Œè¿™æ ·ä¸ç®¡æœ‰å¤šå°‘å°åº”ç”¨æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œéƒ½èƒ½å…±äº«redisä¸­å­˜å‚¨çš„sessionå¯¹è±¡

è¿™é‡Œé‡‡ç”¨çš„åˆ†å¸ƒå¼sessionè§£å†³æ–¹æ¡ˆå°±æ˜¯redisä¿å­˜æ•°æ®ï¼Œä¸‹è¾¹æ˜¯ä¸€äº›ä»£ç ã€

```java
//é¦–å…ˆæ˜¯ç™»é™†é—®é¢˜ï¼Œè¯·æ±‚å‚æ•°è½¬åŒ–ä¸ºLoginVoå¯¹è±¡
//å°†è¯·æ±‚ä¸LoginVoä¼ å…¥miaoshaUserServiceçš„loginä¸­è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œç›´æ¥è¿”å›æˆåŠŸï¼Œå› ä¸ºå¦‚æœç™»å½•å¤±è´¥ä¼šåœ¨loginä¸­æå‰è¿”å›å¤±è´¥ä¿¡æ¯
@PostMapping("/tologin")
@ResponseBody
public Result<Boolean> login(@Valid LoginVo loginVo, HttpServletResponse response) {
    log.info(loginVo.toString());
    String verifyCode = loginVo.getVerifyCodeActual();
    //ç™»å½•,ç™»é™†ä¸­çš„é”™è¯¯åœ¨serverä¸­å¤„ç†å®Œæ¯•ï¼Œè¿”å›å€¼æ— ç”¨
    miaoshaUserService.login(response,loginVo);
    return Result.success(true);
}
```

ä¸Šè¾¹ç”¨åˆ°çš„ä¸€äº›è‡ªå®šä¹‰ç±»ğŸ‘‡
```java
//LoginVoåŒ…å«åŸºæœ¬çš„ä¸€äº›ä¿¡æ¯
public class LoginVo {
    @NotEmpty
    @Digits(integer = 11, fraction = 0)
    private String username;

    @NotEmpty
    @Length(min = 32,max = 32)
    private String password;

    //éªŒè¯ç 
    @NotEmpty
    private String verifyCodeActual;
    ...
}
```

loginä¼šå…ˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨å°±æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸`CodeMsg.USER_NOT_EXIST`,ç´§æ¥ç€æ˜¯åˆ¤æ–­åŠ å¯†ç»“æœæ˜¯å¦ä¸æ•°æ®åº“ç›¸åŒ¹é…ï¼Œè¿™é‡Œç”¨ç”¨åˆ°å¦ä¸€ä¸ªå¼‚å¸¸`CodeMsg.PASSWORD_ERROR`ï¼Œ[è¿™é‡Œæ˜¯å¼‚å¸¸æ‹¦æˆªå™¨çš„ä»£ç ](id=å…¨å±€å¼‚å¸¸æ‹¦æˆªå™¨)
```java
public boolean login(HttpServletResponse response, LoginVo loginVo) {
        if (loginVo == null) {
            throw new GlobleException(CodeMsg.SERVER_ERROR);
        }
        String username = loginVo.getUsername();
        String password = loginVo.getPassword();
        //éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        MiaoshaUser miaoshaUser = getById(Long.parseLong(username));
        if (miaoshaUser == null) {
            throw new GlobleException(CodeMsg.USER_NOT_EXIST);
        }
        //éªŒè¯å¯†ç 
        String dbPass = miaoshaUser.getPassword();
        String dbSlat = miaoshaUser.getSalt();
        String calcPass = MD5Util.FormPassToDBPass(password, dbSlat);
        if (!calcPass.equals(dbPass)) {
            throw new GlobleException(CodeMsg.PASSWORD_ERROR);
        }
        addCookie(miaoshaUser, response);
        return true;
    }
```

ä¼šåœ¨`addCookie()`é‡ŒæŠŠä¿¡æ¯å­˜å‚¨åœ¨Redis

```java
private void addCookie(MiaoshaUser miaoshaUser, HttpServletResponse response) {
        //å¦‚æœç™»é™†æˆåŠŸï¼Œç”Ÿæˆä¸€ä¸ªcookie
        String token = UUIDUtil.uuid();
        //å­—ç¬¦ä¸²å­˜å‚¨åˆ°Redis
        redisService.set(MiaoshaUserKey.token, token, miaoshaUser);
        Cookie cookie = new Cookie(COOKI_NAME_TOKEN, token);
        cookie.setMaxAge(MiaoshaUserKey.token.expireSeconds());
        cookie.setPath("/");
        response.addCookie(cookie);
    }
```

#### JWT

**æ— çŠ¶æ€ç™»å½•**

`session` éœ€è¦åœ¨æ•°æ®åº“ä¸­ä¿æŒç”¨æˆ·åŠtokenå¯¹åº”ä¿¡æ¯ï¼Œæ‰€ä»¥å« **æœ‰çŠ¶æ€**ã€‚

è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚ä½•åœ¨æ•°æ®åº“ä¸­ä¸ä¿æŒç”¨æˆ·çŠ¶æ€ä¹Ÿå¯ä»¥ç™»å½•ã€‚

ç¬¬ä¸€ç§æ–¹æ³•ï¼š **å‰ç«¯ç›´æ¥ä¼  user_id ç»™æœåŠ¡ç«¯**

ç¼ºç‚¹ä¹Ÿç‰¹åˆ«ç‰¹åˆ«æ˜æ˜¾ï¼Œå®¹æ˜“è¢«ç”¨æˆ·ç¯¡æ”¹æˆä»»åŠ¡ user_idï¼Œæƒé™è®¾ç½®å½¢åŒè™šè®¾ã€‚ä¸è¿‡æ€è·¯æ­£ç¡®ï¼Œæ¥ç€å¾€ä¸‹èµ°ã€‚

æ”¹è¿›ï¼š **å¯¹ user_id è¿›è¡Œå¯¹ç§°åŠ å¯†**

æ¯”ä¸Šè¾¹ç•¥å¾®å¼ºç‚¹ï¼Œå¦‚æœè¯´ä¸Šä¸€ç§æ–¹æ³•æ˜¯ç©ºçª—æˆ·ï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯ç³Šäº†çº¸çš„çª—æˆ·ã€‚

æ”¹è¿›ï¼š **å¯¹ user_id ä¸éœ€è¦åŠ å¯†ï¼Œåªéœ€è¦è¿›è¡Œç­¾åï¼Œä¿è¯ä¸è¢«ç¯¡æ”¹**

è¿™ä¾¿æ˜¯ jwt çš„æ€æƒ³ï¼Œuser_idï¼ŒåŠ å¯†ç®—æ³•å’Œç­¾åä¸€èµ·å­˜å‚¨åˆ°å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚æ¥å£æ—¶ï¼ŒæœåŠ¡å™¨åˆ¤æ–­ç­¾åæ˜¯å¦ä¸€è‡´ã€‚

>  ä½œè€…ï¼šshanyueé“¾æ¥ï¼šhttps://juejin.im/post/5b532492e51d455d6825c0cc

#### JWTæ–¹å¼è®¤è¯çš„å¥½å¤„

> 1ã€å› ä¸ºtokenå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨åªè´Ÿè´£è§£ç ã€‚è¿™æ ·ä¸éœ€è¦å ç”¨æœåŠ¡å™¨ç«¯èµ„æºã€‚
> 2ã€æœåŠ¡å™¨ç«¯å¯ä»¥æ— é™æ‰©å±•ï¼Œè´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†ç”¨æˆ·ä¼ é€’åˆ°ä»»ä½•æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨éƒ½èƒ½çŸ¥é“ç”¨æˆ·ä¿¡æ¯ï¼Œå› ä¸ºjwté‡Œé¢åŒ…å«äº†ã€‚
> 3ã€æ•°æ®å®‰å…¨ï¼Œå› ä¸ºæœ‰ç­¾åï¼Œé˜²æ­¢äº†ç¯¡æ”¹ï¼Œä½†ä¿¡æ¯è¿˜æ˜¯é€æ˜çš„ï¼Œä¸è¦æ”¾æ•æ„Ÿä¿¡æ¯ã€‚
> 4ã€æ”¾å…¥è¯·æ±‚å¤´æäº¤ï¼Œå¾ˆå¥½çš„é˜²æ­¢äº†csrfæ”»å‡»ï¼Œ

#### JWTæ–¹å¼çš„åå¤„

##### ä¸€ã€tokenå¤±æ•ˆé—®é¢˜
JWTæ–¹å¼æœ€å¤§çš„åå¤„å°±æ˜¯æ— æ³•ä¸»åŠ¨è®©tokenå¤±æ•ˆï¼Œå°ä¼™ä¼´ä»¬ä¼šè¯´tokenä¸æ˜¯æœ‰è¿‡æœŸæ—¶é—´å—ï¼Ÿæ˜¯çš„ï¼Œtokenæœ¬èº«æ˜¯æœ‰è¿‡æœŸæ—¶é—´ï¼Œä½†tokenä¸€æ—¦å‘å‡ºï¼ŒæœåŠ¡å™¨å°±æ— æ³•æ”¶å›ã€‚

>  å¦‚ï¼šä¸€ä¸ªjwtçš„tokençš„å¤±æ•ˆæ—¶é—´æ˜¯3å¤©ï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ä¸ªtokenæœ‰å¼‚å¸¸ï¼Œæœ‰å¯èƒ½è¢«äººç™»å½•ï¼Œé‚£çœŸå®çš„ç”¨æˆ·å¯ä»¥ä¿®æ”¹å¯†ç ã€‚ä½†æ˜¯å³ä½¿ä¿®æ”¹äº†å¯†ç ï¼Œé‚£ä¸ªå¼‚å¸¸çš„tokenè¿˜æ˜¯åˆæ³•çš„ï¼Œå› ä¸º3å¤©çš„å¤±æ•ˆæ—¶é—´æœªåˆ°ï¼Œæˆ‘ä»¬æœåŠ¡å™¨æ˜¯æ²¡æ³•ä¸»åŠ¨è®©å¼‚å¸¸tokenå¤±æ•ˆã€‚

##### äºŒã€æ•°æ®å»¶æ—¶ï¼Œä¸ä¸€è‡´é—®é¢˜

è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯å› ä¸ºjwtä¸­åŒ…å«äº†ç”¨æˆ·çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚æœè¿™äº›éƒ¨åˆ†ä¿¡æ¯ä¿®æ”¹äº†ï¼ŒæœåŠ¡å™¨è·å–çš„è¿˜æ˜¯ä»¥å‰çš„jwtä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

# â°ç§’æ€

## æ•°æ®åº“è®¾è®¡

```
å¤„ç†é€»è¾‘  //äº‹åŠ¡  1.å‡åº“å­˜ 2.ä¸‹è®¢å• 3.å†™å…¥ç§’æ€è®¢
```

## å•†å“è¯¦æƒ…é¡µ

å‰ç«¯ä½¿ç”¨vueåˆ›å»ºå…¬å…±å¤´éƒ¨ï¼Œä»¥åŠå…¬å…±é¡µè„š

## è®¢å•è¯¦æƒ…é¡µ

- ä½¿ç”¨é›ªèŠ±â„ç®—æ³•ç”Ÿæˆå”¯ä¸€è®¢å•ID

# ğŸ’£å‹åŠ›æµ‹è¯•

## JMeterä»‹ç»



- å‹æµ‹QPS

    - http://127.0.0.1:8080/goods/to_list

    - å®šä¹‰1000ç»„çº¿ç¨‹ï¼Œ0ç§’å¯åŠ¨![1582946858118](images/ç¬”è®°/1582946858118.png)

    - æ·»åŠ é»˜è®¤è¯·æ±‚![1582946971981](images/ç¬”è®°/1582946971981.png)

        - æ·»åŠ (Sampler)å–æ ·å™¨ä¸ºHTTPè¯·æ±‚![1582947139016](images/ç¬”è®°/1582947139016.png)![1582947430511](images/ç¬”è®°/1582947430511.png)

        - æ·»åŠ èšåˆæŠ¥å‘Š![1582947499238](images/ç¬”è®°/1582947499238.png)

        - æ·»åŠ å›¾å½¢ç»“æœ![1582948057716](images/ç¬”è®°/1582948057716.png)

        - ç®€å•ç»“æœï¼ˆQPS=288.5ï¼‰![1582948462844](images/ç¬”è®°/1582948462844.png)

            

## è‡ªå®šä¹‰å˜é‡æ¨¡æ‹Ÿå¤šç”¨æˆ·

1.æµ‹è¯•è®¡åˆ’->æ·»åŠ é…ç½®å…ƒä»¶->CSV Data Set Config
2.å¼•ç”¨å˜é‡${}

- åˆ›å»ºå¸¦tokençš„è¯·æ±‚å»è·å–useræŸ¥è¯¢ï¼Œä»¥æ­¤æ¥åˆ¤æ–­Rediså½±å“QPS![1582954787416](images/ç¬”è®°/1582954787416.png)

    - ç»“æœQPSè¾¾åˆ°2241ï¼Œè¾ƒä¹‹å‰10å€é€Ÿåº¦
    - ![1582955235608](images/ç¬”è®°/1582955235608.png)

- æ·»åŠ CSVæ–‡ä»¶è®¾ç½®ï¼Œç”¨æ¥æ·»åŠ å¤šç”¨æˆ·ä¿¡æ¯

    ![1582955928452](images/ç¬”è®°/1582955928452.png)

    ![1582956665505](images/ç¬”è®°/1582956665505.png)

    è¿™é‡Œç”Ÿæˆäº†1000ä¸ªç”¨æˆ·ï¼Œè¯·æ±‚4000æ¬¡ QPS612

    ![1582976879192](images/ç¬”è®°/1582976879192.png)

    å¹¶ä¸”äº§ç”Ÿäº†è¶…å–é—®é¢˜

    ![1582976922299](images/ç¬”è®°/1582976922299.png)

    å¯ä»¥çœ‹åˆ°å•†å“ä¸­ä¸º-37

    ä¼˜åŒ–å¹¶é‡æ–°æµ‹è¯•ï¼Œç»“æœ:æ­¤æ¬¡æœªè¶…å–![1582977703316](images/ç¬”è®°/1582977703316.png)

## JMeterå‘½ä»¤è¡Œ

- åœ¨windows.ä¸Šå½•å¥½jmx
- å‘½ä»¤è¡Œ: `sh jmeter.sh -n -t XXX.jmx -I result.jtl`
- æŠŠresult.jtlå¯¼å…¥åˆ°jmeter

## Rediså‹æµ‹å·¥å…·redis-benchmark

Rediså‹æµ‹
1. `redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000`
100ä¸ªå¹¶å‘è¿æ¥ï¼Œ1 00000ä¸ªè¯·æ±‚
2. `redis-benchmark -h 127.0.0.1 -p 6379 -q -d 100`
å­˜å–å¤§å°ä¸º100å­—èŠ‚çš„æ•°æ®åŒ…

## mysqlæ€§èƒ½æµ‹è¯•

![1584522117836](images/å¼€å‘ç¬”è®°/1584522117836.png)



# ğŸŒ–å®Œå–„ä¼˜åŒ–ç³»ç»Ÿ

## é¡µé¢ä¼˜åŒ–

### é¡µé¢ç¼“å­˜ã€URLç¼“å­˜ã€å¯¹è±¡ç¼“å­˜

- é¡µé¢ç¼“å­˜æ˜¯å°†é¡µé¢ç¼“å­˜åˆ°Redisï¼Œæ—¶é—´1åˆ†é’Ÿï¼Œæˆ‘å¯¹è¿™ç§åšæ³•æ— æ„Ÿï¼Œè§‚æ„Ÿä¸Šä¸å¦‚é¡µé¢é™æ€åŒ–

- å¯¹è±¡ç¼“å­˜

    æ·»åŠ User Redisç¼“å­˜ï¼Œåªè¦Useræœªå‘ç”Ÿå˜åŒ–ï¼Œå¸Œæœ›æ°¸ä¹…æœ‰æ•ˆ

    å¯¹åŸæ¥çš„è·å–userInfoæ¥å£è¿›è¡Œå‹æµ‹

    å…³äºRediså‹æµ‹è¿æ¥è¶…æ—¶é—®é¢˜

    1. æ­å»ºå‹åŠ›æµ‹è¯•ç¯å¢ƒï¼Œæ¨¡æ‹Ÿç°ç½‘å‹åŠ›ï¼ŒåŒæ ·å‡ºç°äº†rediså»ºç«‹è¿æ¥å¤±è´¥ï¼Œå¼‚å¸¸æ˜¾ç¤ºsocket connection timeout

    2. å°è¯•ä¿®æ”¹è¿æ¥æ± é…ç½®ï¼Œå°†idlè°ƒæˆå’Œtotalä¸€è‡´ï¼Œå‡ä¸º200ï¼Œé—®é¢˜å¹¶æœªè§£å†³ã€‚
    3. å°è¯•åŠ å¤§è¿æ¥æ± æ•°é‡ï¼Œé—®é¢˜å¹¶æœªè§£å†³
    4. redisæœåŠ¡å™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œå³åŒä¸€æ—¶åˆ»ï¼Œä»…å¤„ç†ä¸€ä¸ªè¿æ¥å‘å‡ºçš„æŒ‡ä»¤ï¼Œé‚£ä¹ˆè¿æ¥æ± ä¸­çš„å¤šä¸ªè¿æ¥ï¼Œè™½ç„¶å°†æŒ‡ä»¤å‘é€è‡³redisï¼Œä½†rediså¹¶æœªç«‹å³å¤„ç†ï¼Œè€Œæ˜¯åœ¨æ’é˜Ÿã€‚é‚£ä¹ˆï¼Œä¸å…¶å°†æŒ‡ä»¤å‘é€ç»™redisï¼Œåœ¨redisç«¯æ’é˜Ÿï¼Œä¸å¦‚åœ¨æœ¬è¿›ç¨‹å†…æ’é˜Ÿï¼Œæš‚ä¸å°†æŒ‡ä»¤å‘é€è‡³redisï¼Œå³å°†redisè¿æ¥æ± idl/totalå‡è®¾ä¸º1ï¼Œä»…ç»´æŒä¸€æ¡ä¸redisçš„è¿æ¥ï¼Œå¦‚æœä¸šåŠ¡é‡è¿‡å¤§ï¼Œæœ¬è¿›ç¨‹å†…æ’é˜Ÿè¶…æ—¶ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…ä»è¿æ¥æ± è·å–è¿æ¥è¶…æ—¶ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡åŠ å¤§è¿æ¥æ± çš„maxwaitå€¼æ¥è§£å†³ã€‚æƒ³åˆ°æ­¤ç‚¹ä¹‹åï¼Œå°†è¿æ¥æ± idl/totalè°ƒæ•´ä¸º1ï¼Œå¼€å§‹å‹åŠ›æµ‹è¯•ï¼Œæœªå†å‡ºç°è¿æ¥å»ºç«‹è¶…æ—¶
    5. ç»éªŒï¼šredisæœåŠ¡å™¨æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ŒåŠ å¤§è¿æ¥æ± ï¼Œåªæ˜¯åŠ å¤§æ’é˜Ÿçš„é˜Ÿåˆ—æ•°ï¼Œä½†æ˜¯ï¼Œredisæ˜¯å¤šè¿›ç¨‹å…±ç”¨ï¼Œå‹åŠ›è¾ƒå¤§ï¼Œåœ¨å¤„ç†å¤§é‡çš„redisæŒ‡ä»¤çš„åŒæ—¶ï¼Œè¿˜è¦ç»´æŠ¤å¤§é‡çš„è¿æ¥ï¼Œæ˜¯å¾ˆè€—èµ„æºçš„ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªè¿›ç¨‹ä»…ç»´æŒä¸€æ¡ä¸redisçš„è¿æ¥ï¼Œé€šè¿‡åŠ å¤§maxwaitï¼Œæ¥æ§åˆ¶åœ¨æœ¬è¿›ç¨‹å†…æ’é˜Ÿï¼Œå¯ä»¥é™ä½redisçš„å‹åŠ›ã€‚rediså’Œmysqlç­‰ä¸åŒï¼Œmysqlæ˜¯å¯ä»¥å¤šä¸ªè¿æ¥çš„æŒ‡ä»¤å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿æ¥æ± è®¾ç½®è¿‡å¤§æ²¡æœ‰æ„ä¹‰

### é¡µé¢é™æ€åŒ–ï¼Œå‰åç«¯åˆ†ç¦»

å‰åç«¯åˆ†ç¦»å‰ç«¯é¡µé¢å¯ä»¥ä½¿ç”¨Vueï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„å¤„ç†åç«¯å‚æ•°

è¿™é‡Œä½¿ç”¨vueçš„ä¸€ä¸ªå‰ç«¯æ¡†æ¶ `ElementUI`ï¼Œå‰ç«¯é¡¹ç›®ä½¿ç”¨nodejs(nginx)ï¼Œåç«¯é¡¹ç›®ä½¿ç”¨springbootï¼Œ

- å‰ç«¯åœ°å€

    http://localhost:8081/

- åç«¯åœ°å€

    http://localhost:8080/

ç›´æ¥è¯·æ±‚ä¼šäº§ç”Ÿè·¨åŸŸé—®é¢˜(å¯ä»¥ä½¿ç”¨nginxåå‘ä»£ç†è§£å†³)

> è·¨åŸŸï¼šæŒ‡çš„æ˜¯æµè§ˆå™¨ä¸èƒ½æ‰§è¡Œå…¶ä»–ç½‘ç«™çš„è„šæœ¬ã€‚å®ƒæ˜¯ç”±æµè§ˆå™¨çš„åŒæºç­–ç•¥é€ æˆçš„ï¼Œæ˜¯æµè§ˆå™¨å¯¹javascriptæ–½åŠ çš„å®‰å…¨é™åˆ¶

è¿™é‡Œéœ€è¦åç«¯æ”¯æŒ`CORS`è·¨åŸŸè¯·æ±‚

é…ç½®å¦‚ä¸‹ï¼Œè¿™é‡Œæˆ‘åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†å‰ç«¯åœ°å€ï¼Œåç«¯å¯ä»¥è¿™æ ·è·å–

```java
 //å‰ç«¯åœ°å€
@Value("${frontEndHost}")
String frontHost;
```

åœ¨`cn.peoplevip.miaosha.config`ä¸‹çš„`WebConfig.java`æ–‡ä»¶ä¸­ä¹¦å†™ä»¥ä¸‹ä»£ç 

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedOrigins(frontHost);
    }
}
```

### é™æ€èµ„æºä¼˜åŒ–

1. JS/CSS å‹ç¼©ï¼Œå‡å°‘æµé‡
2. å¤šä¸ªJS/CSSç»„åˆï¼Œå‡å°‘è¿æ¥æ•°

### CDNä¼˜åŒ–

1. ä¸Šä¼ åˆ°GitHubï¼Œå½“ä½œCDN
2. é‡‡ç”¨å‰ç«¯CDN(å†…å®¹åˆ†å‘ç½‘ç»œ)

## æ¥å£ä¼˜åŒ–

å¼‚æ­¥ä¸‹å•

### Redisé¢„å‡åº“å­˜å‡å°‘æ•°æ®åº“è®¿é—®

- è§£å†³è¶…å–

    1. æ•°æ®åº“åŠ å”¯ä¸€ç´¢å¼•:é˜²æ­¢ç”¨æˆ·é‡å¤è´­ä¹°

        >  sql ä½¿ç”¨`ignore`å…³é”®å­—é˜²æ­¢æ•°æ®åº“æŠ¥é”™
        >
        > ```
        > INSERT IGNORE INTO
        > ```
        >
        > ignoreå…³é”®å­—æ‰€ä¿®é¥°çš„SQLè¯­å¥æ‰§è¡Œåï¼Œåœ¨é‡åˆ°ä¸»é”®å†²çªæ—¶ä¼šè¿”å›ä¸€ä¸ª0ï¼Œä»£è¡¨å¹¶æ²¡æœ‰æ’å…¥æ­¤æ¡æ•°æ®ã€‚å¦‚æœä¸»é”®æ˜¯ç”±åå°ç”Ÿæˆçš„ï¼ˆå¦‚uuidï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­è¿™ä¸ªè¿”å›å€¼æ˜¯å¦ä¸º0æ¥åˆ¤æ–­ä¸»é”®æ˜¯å¦æœ‰å†²çªï¼Œä»è€Œé‡æ–°ç”Ÿæˆæ–°çš„ä¸»é”®ke

    2. SQLåŠ åº“å­˜æ•°é‡åˆ¤æ–­:é˜²æ­¢åº“å­˜å˜æˆè´Ÿæ•°

- æ€è·¯ï¼šå‡å°‘æ•°æ®åº“è®¿é—®

    1. ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒæŠŠå•†å“åº“å­˜æ•°é‡åŠ è½½åˆ°Redis
    2. æ”¶åˆ°è¯·æ±‚ï¼ŒRedisé¢„å‡åº“å­˜ï¼Œåº“å­˜ä¸è¶³,ç›´æ¥è¿”å›,å¦åˆ™è¿›å…¥3
    3. è¯·æ±‚å…¥é˜Ÿ,ç«‹å³è¿”å›æ’é˜Ÿä¸­
    4. è¯·æ±‚å‡ºé˜Ÿ,ç”Ÿæˆè®¢å•,å‡å°‘åº“å­˜
    5. å®¢æˆ·ç«¯è½®è¯¢,æ˜¯å¦ç§’æ€æˆåŠŸ


### å†…å­˜æ ‡è®°å‡å°‘Redisè®¿é—®

è®¾ç½®ä¸€ä¸ªMapï¼Œç”¨äºå­˜å‚¨æ˜¯å¦ç§’æ€å®Œæ¯•ï¼Œç§’æ€å®Œæ¯•åä¸è¿›è¡ŒRedisè¯·æ±‚

### è¯·æ±‚å…ˆå…¥é˜Ÿç¼“å†²,å¼‚æ­¥ä¸‹å•,å¢å¼ºç”¨æˆ·ä½“éªŒ

```java
@RabbitListener(queues = MQConfig.MIAOSHA_QUEUE)
public void receive(String message) {
    log.info("receive message:" + message);
    MiaoshaMessage mm = RedisService.strToBean(message, MiaoshaMessage.class);
    MiaoshaUser user = mm.getUser();
    long goodsId = mm.getGoodsId();

    GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);
    if (goods == null) {
        return;
    }
    int stock = goods.getStockCount();
    //åˆ¤æ–­åº“å­˜
    if (stock <= 0) {
        return;
    }
    //åˆ¤æ–­æ˜¯å¦å·²ç»ç§’æ€åˆ°äº†
    MiaoshaOrder miaoshaOrder = orderService.getMiaoshaOrderByUserIdGoodsId(user.getId(), goodsId);
    if (miaoshaOrder != null) {
        //å·²ç»ç§’æ€è¿‡
        return;
    }
    //äº‹åŠ¡  1.å‡åº“å­˜ 2.ä¸‹è®¢å• 3.å†™å…¥ç§’æ€è®¢å•
    OrderInfo orderInfo = miaoshaService.miaosha(user, goods);
}
```



### RabbitMQå®‰è£…ä¸Spring Booté›†æˆ

æœ€ä¸ºå¸¸è§çš„å‰Šå³°æ–¹æ¡ˆæ˜¯ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡æŠŠåŒæ­¥çš„ç›´æ¥è°ƒç”¨è½¬æ¢æˆå¼‚æ­¥çš„é—´æ¥æ¨é€ç¼“å†²ç¬æ—¶æµé‡ã€‚é™¤äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼çš„æ’é˜Ÿæ–¹æ¡ˆè¿˜æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ï¼š

1. çº¿ç¨‹æ± åŠ é”ç­‰å¾…
2. æœ¬åœ°å†…å­˜è“„æ´ªç­‰å¾…
3. æœ¬åœ°æ–‡ä»¶åºåˆ—åŒ–å†™ï¼Œå†é¡ºåºè¯»

æ’é˜Ÿæ–¹å¼çš„å¼Šç«¯ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

1. è¯·æ±‚ç§¯å‹ã€‚æµé‡é«˜å³°å¦‚æœé•¿æ—¶é—´æŒç»­ï¼Œè¾¾åˆ°äº†é˜Ÿåˆ—çš„æ°´ä½ä¸Šé™ï¼Œé˜Ÿåˆ—åŒæ ·ä¼šè¢«å‹å®ï¼Œè¿™æ ·è™½ç„¶ä¿æŠ¤äº†ä¸‹æ¸¸ç³»ç»Ÿï¼Œä½†æ˜¯å’Œè¯·æ±‚ç›´æ¥ä¸¢å¼ƒä¹Ÿæ²¡å¤šå¤§åŒºåˆ«
2. ç”¨æˆ·ä½“éªŒã€‚å¼‚æ­¥æ¨é€çš„å®æ—¶æ€§å’Œæœ‰åºæ€§è‡ªç„¶æ˜¯æ¯”ä¸ä¸ŠåŒæ­¥è°ƒç”¨çš„ï¼Œç”±æ­¤å¯èƒ½å‡ºç°è¯·æ±‚å…ˆå‘åè‡³çš„æƒ…å†µï¼Œå½±å“éƒ¨åˆ†æ•æ„Ÿç”¨æˆ·çš„è´­ç‰©ä½“éªŒ

æ’é˜Ÿæœ¬è´¨æ˜¯åœ¨ä¸šåŠ¡å±‚å°†ä¸€æ­¥æ“ä½œè½¬å˜æˆä¸¤æ­¥æ“ä½œï¼Œä»è€Œèµ·åˆ°ç¼“å†²çš„ä½œç”¨ï¼Œä½†é‰´äºæ­¤ç§æ–¹å¼çš„å¼Šç«¯ï¼Œæœ€ç»ˆè¿˜æ˜¯è¦åŸºäºä¸šåŠ¡é‡çº§å’Œç§’æ€åœºæ™¯åšå‡ºå¦¥åå’Œå¹³è¡¡ã€‚

[å‚è€ƒé“¾æ¥](https://segmentfault.com/a/1190000020970562#item-5-12)

ä»¥ä¸‹ä¸ºRabbitMqé›†æˆ

- é›†æˆRabbitMQ

rabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPåè®®æ ‡å‡†åŸºç¡€ä¸Šå®Œæ•´çš„ï¼Œå¯æœç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒéµå¾ªMozilla Public Licenseå¼€æºåè®®ï¼Œé‡‡ç”¨ Erlang å®ç°çš„å·¥ä¸šçº§çš„æ¶ˆæ¯é˜Ÿåˆ—(MQ)æœåŠ¡å™¨ï¼ŒRabbit MQ æ˜¯å»ºç«‹åœ¨Erlang OTPå¹³å°ä¸Š[RabbitMQå…¥é—¨åŠå…¶å‡ ç§å·¥ä½œæ¨¡å¼](./RabbitMQå…¥é—¨åŠå…¶å‡ ç§å·¥ä½œæ¨¡å¼.md)

> å®‰è£…æ•™ç¨‹  https://blog.csdn.net/zhm3023/article/details/82217222
>
> ![1583306265283](images/ç¬”è®°/1583306265283.png)
>
> 

1. æ·»åŠ ä¾èµ–spring-boot-starter-amqp

    ```xml
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-amqp</artifactId>
    </dependency>
    ```

    

2. åˆ›å»ºæ¶ˆæ¯æ¥å—è€…

3. åˆ›å»ºæ¶ˆæ¯å‘é€è€…

    > æ¶ˆæ¯æ¥æ”¶è€…æ‰§è¡Œç§’æ€

### Nginxæ°´å¹³æ‰©å±•

åå‘ä»£ç†

### å‹æµ‹

å¢åŠ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†…å­˜æ ‡è®°åè¿›è¡Œå‹æµ‹

![1583397724327](images/ç¬”è®°/1583397724327.png)

![1583403643608](images/ç¬”è®°/1583403643608.png)

## å®‰å…¨ä¼˜åŒ–

### ç§’æ€æ¥å£åœ°å€éšè—

- æ€è·¯ï¼šç§’æ€å¼€å§‹ä¹‹å‰ï¼Œå…ˆå»è¯·æ±‚æ¥å£è·å–ç§’æ€åœ°å€

    1. æ¥å£æ”¹é€ ï¼Œå¸¦ä¸ŠPathVariableå‚æ•°

    2. æ·»åŠ ç”Ÿæˆåœ°å€æ¥å£

    3. ç§’æ€æ”¶åˆ°è¯·æ±‚ï¼Œå…ˆéªŒè¯PathVariable

        ```java
         public boolean checkPath(MiaoshaUser user, long goodsId, String path) {
                if (user == null || path == null) {
                    return false;
                }
                String pathOld = redisService.get(MiaoshaKey.getMiaoshaPath, user.getId() + "_" + goodsId, String.class);
                return path.equals(pathOld);
            }
        
            public String createMiaoshaPath(MiaoshaUser user, long goodsId) {
                String hash = MD5Util.getMD5(UUIDUtil.uuid() + "");
                redisService.set(MiaoshaKey.getMiaoshaPath, user.getId() + "_" + goodsId, hash);
                return hash;
            }
        ```

        

### æ•°å­¦å…¬å¼éªŒè¯ç 

éªŒè¯ç åˆ©äºå°†å¹¶å‘å‰Šå‡ 

> æ€è·¯:ç‚¹å‡»ç§’æ€ä¹‹å‰,å…ˆè¾“å…¥éªŒè¯ç ï¼Œåˆ†æ•£ç”¨æˆ·çš„è¯·æ±‚
>
> é€šè¿‡æå‡è´­ä¹°çš„å¤æ‚åº¦ï¼Œè¾¾åˆ°ä¸¤ä¸ªç›®çš„ï¼š
>
> 1. é˜²æ­¢ä½œå¼Šã€‚æ—©æœŸç§’æ€å™¨æ¯”è¾ƒçŒ–ç—ï¼Œå­˜åœ¨æ¶æ„ä¹°å®¶æˆ–ç«äº‰å¯¹æ‰‹ä½¿ç”¨ç§’æ€å™¨æ‰«è´§çš„æƒ…å†µï¼Œå•†å®¶æ²¡æœ‰è¾¾åˆ°è¥é”€çš„ç›®çš„ï¼Œæ‰€ä»¥å¢åŠ ç­”é¢˜æ¥è¿›è¡Œé™åˆ¶
> 2. å»¶ç¼“è¯·æ±‚ã€‚é›¶ç‚¹æµé‡çš„èµ·æ•ˆæ—¶é—´æ˜¯æ¯«ç§’çº§çš„ï¼Œç­”é¢˜å¯ä»¥äººä¸ºæ‹‰é•¿å³°å€¼ä¸‹å•çš„æ—¶é•¿ï¼Œç”±ä¹‹å‰çš„ <1s å»¶é•¿åˆ° <10sã€‚è¿™ä¸ªæ—¶é—´å¯¹äºæœåŠ¡ç«¯éå¸¸é‡è¦ï¼Œä¼šå¤§å¤§å‡è½»é«˜å³°æœŸå¹¶å‘å‹åŠ›ï¼›å¦å¤–ï¼Œç”±äºè¯·æ±‚å…·æœ‰å…ˆåé¡ºåºï¼Œç­”é¢˜åç½®çš„è¯·æ±‚åˆ°æ¥æ—¶å¯èƒ½å·²ç»æ²¡æœ‰åº“å­˜äº†ï¼Œå› æ­¤æ ¹æœ¬æ— æ³•ä¸‹å•ï¼Œæ­¤é˜¶æ®µè½åˆ°æ•°æ®å±‚çœŸæ­£çš„å†™ä¹Ÿå°±éå¸¸æœ‰é™äº†

1. æ·»åŠ ç”ŸæˆéªŒè¯ç çš„æ¥å£
2. åœ¨è·å–ç§’æ€è·¯å¾„çš„æ—¶å€™,éªŒè¯éªŒè¯ç 
3. ScriptEngineä½¿ç”¨(ä½¿ç”¨JSè®¡ç®—è¡¨è¾¾å¼)

ä½¿ç”¨Kaptchaæ¥ç”ŸæˆéªŒè¯ç 

éªŒè¯ç è¿”å›ä¸¤ç§å½¢å¼ 

1. ç›´æ¥è¿”å›å›¾ç‰‡

```java
BufferedImage image = kaptchaService.createVerifyCode(user,goodsId);
        try(OutputStream out = response.getOutputStream()){
            ImageIO.write(image, "jpg", out);
        }
```

2. è¿”å›base64æ ¼å¼å­—ç¬¦ä¸²

```java
 BufferedImage image = kaptchaService.createVerifyCode(user,goodsId);
        //try(ByteArrayOutputStream outputStream = new ByteArrayOutputStream()){
//            ImageIO.write(image, "jpg", outputStream);
//            // å¯¹å­—èŠ‚æ•°ç»„Base64ç¼–ç 
////            BASE64Encoder encoder = new BASE64Encoder();
////            encoder.encode(outputStream.toByteArray());
////            HashMap<String,String> map = new HashMap<>();
////            map.put("img", encoder.encode(outputStream.toByteArray()));
```



### æ¥å£çš„é™æµ

é™åˆ¶æŸä¸€æ¥å£å•ç”¨æˆ·è®¿é—®æ¬¡æ•°

>  æ€è·¯:å¯¹æ¥å£åšé™æµï¼Œå°†è®¿é—®æ¬¡æ•°æ”¾å…¥ç¼“å­˜ä¸­ï¼Œå¹¶å¯¹ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸ

 å¸Œæœ›å®ç°æ•ˆæœï¼Œåœ¨æ¥å£ä¸Šå£°æ˜æ³¨è§£

```java
@AccessLimit(seconds=5, maxCount=5, needLogin=true)

//å†™ä¸€ä¸ªæ³¨è§£
@Retention(RUNTIME)
@Target(METHOD)
public @interface AccessLimit {
    int seconds();
    int maxCount();
    boolean needLogin() default true;

}
//å†™ä¸€ä¸ªæ‹¦æˆªå™¨æ‹¦æˆªæœ‰è¯¥æ³¨è§£çš„è¯·æ±‚
@Service
public class AccessInterceptor extends HandlerInterceptorAdapter {

    @Autowired
    MiaoshaUserService userService;

    @Autowired
    RedisService redisService;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        if (handler instanceof HandlerMethod) {
            MiaoshaUser user = getUser(request, response);
            UserContext.setUser(user);
            HandlerMethod hm = (HandlerMethod) handler;
            //æ‹¿åˆ°æ³¨è§£
            AccessLimit accessLimit = hm.getMethodAnnotation(AccessLimit.class);
            if (accessLimit == null) {
                return true;
            }

            int seconds = accessLimit.seconds();
            int maxCount = accessLimit.maxCount();
            boolean needLogin = accessLimit.needLogin();
            String key = request.getRequestURI();
            if (needLogin) {
                if (user == null) {
                    render(response, CodeMsg.USER_NOT_LOGIN);
                    return false;
                }
                key += "_" + user.getId();
            }

            AccessKey ak = AccessKey.withExpire(seconds);
            Integer count = redisService.get(ak, key, Integer.class);
            if(count  == null) {
                redisService.set(ak, key, 1);
            }else if(count < maxCount) {
                redisService.incr(ak, key);
            }else {
                render(response, CodeMsg.ACCESS_LIMIT_REACHED);
                return false;
            }
        }
        return true;
    }

    private void render(HttpServletResponse response, CodeMsg userNotLogin) throws Exception {
        OutputStream out = response.getOutputStream();
        String str = JSON.toJSONString(userNotLogin);
        out.write(str.getBytes(StandardCharsets.UTF_8));
        out.flush();
        out.close();
    }

    private MiaoshaUser getUser(HttpServletRequest request, HttpServletResponse response) {

        String ParamToken = request.getParameter(MiaoshaUserService.COOKI_NAME_TOKEN);
        String cookieToken = getCookieValue(request, MiaoshaUserService.COOKI_NAME_TOKEN);

        if (StringUtils.isEmpty(cookieToken) && StringUtils.isEmpty(ParamToken)) {
            return null;
        }
        String token = StringUtils.isEmpty(ParamToken) ? cookieToken : ParamToken;
        //å–å‡ºcookieï¼Œä¾èµ–tokenæ¥è·å–ç™»å½•çŠ¶æ€
        MiaoshaUser user = userService.getByToken(token, response);
        return user;
    }

    private String getCookieValue(HttpServletRequest request, String cookiNameToken) {
        Cookie[] cookies = request.getCookies();
        if (cookies == null || cookies.length <= 0) {
            return null;
        }
        for (Cookie cookie : cookies) {
            if (cookie.getName().equals(cookiNameToken)) {
                return cookie.getValue();
            }
        }
        return null;
    }
}

//åœ¨WebConfigä¸­é…ç½®

```

## æ¥å…¥Swagger2

- æ·»åŠ ä¾èµ–

```xml
<properties>
        <swagger2.version>2.9.2</swagger2.version>
</properties>
 <!--Swagger-UI APIæ–‡æ¡£ç”Ÿäº§å·¥å…·-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>${swagger2.version}</version>
</dependency>
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger-ui</artifactId>
    <version>${swagger2.version}</version>
</dependency>
```

- æ·»åŠ è®¾ç½®ç±»

```java
@Configuration
@EnableSwagger2
public class Swagger2Config {
    @Bean
    public Docket createRestApi() {
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo())
                .pathMapping("/")
                .select()
                .apis(RequestHandlerSelectors.basePackage("cn.peoplevip.miaosha.Controller"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("SpringBootæ•´åˆSwagger")
                .description("SpringBootæ•´åˆSwaggerï¼Œè¯¦ç»†ä¿¡æ¯......")
                .version("1.0")
                .build();
    }
}

```

```java
//ä½¿ç”¨æ–¹æ³•ï¼Œæ³¨è§£
 * @Apiï¼šä¿®é¥°æ•´ä¸ªç±»ï¼Œæè¿°Controllerçš„ä½œç”¨
 * @ApiOperationï¼šæè¿°ä¸€ä¸ªç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæ¥å£
 * @ApiParamï¼šå•ä¸ªå‚æ•°æè¿°
 * @ApiModelï¼šç”¨å¯¹è±¡æ¥æ¥æ”¶å‚æ•°
 * @ApiPropertyï¼šç”¨å¯¹è±¡æ¥æ”¶å‚æ•°æ—¶ï¼Œæè¿°å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ
 * @ApiResponseï¼šHTTPå“åº”å…¶ä¸­1ä¸ªæè¿°
 * @ApiResponsesï¼šHTTPå“åº”æ•´ä½“æè¿°
 * @ApiIgnoreï¼šä½¿ç”¨è¯¥æ³¨è§£å¿½ç•¥è¿™ä¸ªAPI
 * @ApiError ï¼šå‘ç”Ÿé”™è¯¯è¿”å›çš„ä¿¡æ¯
 * @ApiImplicitParamï¼šä¸€ä¸ªè¯·æ±‚å‚æ•°
 * @ApiImplicitParamsï¼šå¤šä¸ªè¯·æ±‚å‚æ•°
```

- æ–‡æ¡£ç”Ÿæˆåœ°å€

http://localhost:8080/swagger-ui.html

- åŠŸèƒ½å¼€å¯

```
åœ¨Applicationå¯åŠ¨ç±»ä¸ŠåŠ æ³¨è§£ 
@SpringBootApplication
@EnableSwagger2
public class MiaoshaApplication {
    public static void main(String[] args) {
        SpringApplication.run(MiaoshaApplication.class, args);
    }
}
```

## ä½¿ç”¨headerä¼ é€’tokenå‚æ•°

å…ˆè¯´ç»“è®ºï¼Œå¯é˜²æŠ¤CSRFæ”»å‡»

è·¨ç«™è¯·æ±‚ä¼ªé€ [Cross-site request forgery](https://link.jianshu.com?t=https://en.wikipedia.org/wiki/Cross-site_request_forgery)ï¼ˆç®€ç§°CSRF, è¯»ä½œ [sea-surf]ï¼‰æ˜¯ä¸€ç§å…¸å‹çš„åˆ©ç”¨cookie-sessionæ¼æ´çš„æ”»å‡»ï¼Œè¿™é‡Œå€Ÿç”¨[spring-security](https://link.jianshu.com?t=https://docs.spring.io/spring-security/site/docs/current/reference/html/csrf.html)çš„ä¸€ä¸ªä¾‹å­æ¥è§£é‡ŠCSRFï¼š

å‡è®¾ä½ ç»å¸¸ä½¿ç”¨bank.example.comè¿›è¡Œç½‘ä¸Šè½¬è´¦ï¼Œåœ¨ä½ æäº¤è½¬è´¦è¯·æ±‚æ—¶bank.example.comçš„å‰ç«¯ä»£ç ä¼šæäº¤ä¸€ä¸ªHTTPè¯·æ±‚:



```dart
POST /transfer HTTP/1.1
Host: bank.example.com
cookie: JsessionID=randomid; Domain=bank.example.com; Secure; HttpOnly
Content-Type: application/x-www-form-urlencoded

amount=100.00&routingNumber=1234&account=9876
```

ä½ å›¾æ–¹ä¾¿æ²¡æœ‰ç™»å‡ºbank.example.comï¼Œéšååˆè®¿é—®äº†ä¸€ä¸ªæ¶æ„ç½‘ç«™ï¼Œè¯¥ç½‘ç«™çš„HTMLé¡µé¢åŒ…å«äº†è¿™æ ·ä¸€ä¸ªè¡¨å•ï¼š



```xml
<form action="https://bank.example.com/transfer" method="post">
    <input type="hidden" name="amount" value="100.00"/>
    <input type="hidden" name="routingNumber" value="evilsRoutingNumber"/>
    <input type="hidden" name="account" value="evilsAccountNumber"/>
    <input type="submit" value="ç‚¹å‡»å°±é€!"/>
</form>
```

ä½ è¢«â€œç‚¹å‡»å°±é€â€å¸å¼•äº†ï¼Œå½“ä½ ç‚¹äº†æäº¤æŒ‰é’®æ—¶ä½ å·²ç»å‘æ”»å‡»è€…çš„è´¦å·è½¬äº†100å…ƒã€‚ç°å®ä¸­çš„æ”»å‡»å¯èƒ½æ›´éšè”½ï¼Œæ¶æ„ç½‘ç«™çš„é¡µé¢å¯èƒ½ä½¿ç”¨Javascriptè‡ªåŠ¨å®Œæˆæäº¤ã€‚å°½ç®¡æ¶æ„ç½‘ç«™æ²¡æœ‰åŠæ³•ç›—å–ä½ çš„session cookieï¼ˆä»è€Œå‡å†’ä½ çš„èº«ä»½ï¼‰ï¼Œä½†æ¶æ„ç½‘ç«™å‘bank.example.comå‘èµ·è¯·æ±‚æ—¶ï¼Œä½ çš„cookieä¼šè¢«è‡ªåŠ¨å‘é€è¿‡å»ã€‚

å› æ­¤ï¼Œæœ‰äº›äººè®¤ä¸ºå‰ç«¯ä»£ç å°†JWTé€šè¿‡HTTP headerå‘é€ç»™æœåŠ¡ç«¯ï¼ˆè€Œä¸æ˜¯é€šè¿‡cookieè‡ªåŠ¨å‘é€ï¼‰å¯ä»¥æœ‰æ•ˆé˜²æŠ¤CSRFã€‚åœ¨è¿™ç§æ–¹æ¡ˆä¸­ï¼ŒæœåŠ¡ç«¯ä»£ç åœ¨å®Œæˆè®¤è¯åï¼Œä¼šåœ¨HTTP responseçš„headerä¸­è¿”å›JWTï¼Œå‰ç«¯ä»£ç å°†è¯¥JWTå­˜æ”¾åˆ°Local Storageé‡Œå¾…ç”¨ï¼Œæˆ–æ˜¯æœåŠ¡ç«¯ç›´æ¥åœ¨cookieä¸­ä¿å­˜HttpOnly=falseçš„JWTã€‚

## aopåˆ‡é¢è®°å½•æ—¥å¿—

1. åœ¨`SpringBoot`resouecesç›®å½•ä¸‹æ–°å»º `logback-spring.xml `é…ç½®æ–‡ä»¶
2. æ–°å»ºAopLog.java
3. æ‹¦æˆªè¯·æ±‚ä¿¡æ¯ä»¥åŠè¿”å›ä¿¡æ¯ï¼Œå¹¶æ‰“å°åˆ°æ—¥å¿—æ–‡ä»¶
4. ä½¿ç”¨ThreadLocalå­˜å‚¨æ—¥å¿—ä¿¡æ¯ï¼Œä¿è¯ä¸€æ¡logæ‰“å°å‡ºæ‰€æœ‰éœ€è¦çš„ä¿¡æ¯

# å¾®æœåŠ¡æ¶æ„å¤„ç†

> å¿ƒæ€å´©äº†ï¼Œè¿™é‡Œå·®ä¸å¤šåˆé‡æ„ä¸€éé¡¹ç›®ï¼Œåˆšå¼€å§‹æ²¡è¿›è¡ŒæŠ€æœ¯é€‰å‹ï¼Œä½¿ç”¨çš„æ˜¯å•ä½“æ¶æ„
>
> å…³äºå•ä¾‹æ¶æ„å’Œå¾®æœåŠ¡æ¶æ„äºŒè€…å„æœ‰åˆ©å¼Š

- ä½¿ç”¨SpringCloud alibaba
- Nocas
    - Nocas-clientæ³¨å†Œ
- ä½¿ç”¨`dubbo`çš„RPCè¿›è¡Œå¾®æœåŠ¡é€šä¿¡
- `GateWay`ç½‘å…³è¿›è¡Œè¯·æ±‚æ§åˆ¶
- `Sentine`æ¥å£é™æµ

# å‰ç«¯Vueå¼€å‘

 åˆ›å»ºå…¬å…±å¤´header

https://www.cnblogs.com/lgx5/p/10786102.html

### ç”¨æˆ·æƒé™è¡¨

æ·»åŠ adminç›®å½•è®¿é—®æƒé™éªŒè¯

å€Ÿé‰´é¡¹ç›®  https://github.com/macrozheng/mall-admin-web

åªå€Ÿé‰´å‰ç«¯éƒ¨åˆ†

# NGINXè´Ÿè½½å‡è¡¡é…ç½®

é€‚ç”¨äºç¼–è¾‘å™¨`IDEA`ï¼Œç¼–è¾‘å‹¾é€‰

![1585055659692](images/å¼€å‘ç¬”è®°/1585055659692.png)

ä»¥å•æœºåŒTomcatä¸ºä¾‹

1. å¯åŠ¨`æœåŠ¡1`

2. ä¿®æ”¹ç«¯å£å¯åŠ¨`æœåŠ¡2`

3. nginxé…ç½®æ–‡ä»¶ç¤ºä¾‹

    ```
    http {
        upstream  miaosha-server {
               server    localhost:8661;
               server    localhost:8662;
               fair;
        }
        server {
                listen        8666;
                server_name  localhost;
                location / {
                    proxy_pass http://miaosha-server;
                    proxy_redirect default;
                }
        }
    }
    ```

    

# é‡æ„å¾®æœåŠ¡

è€ƒè™‘åˆ°ç³»ç»Ÿä½¿ç”¨å•ä½“æ¶æ„å¯èƒ½ä¸æ»¡è¶³ç§’æ€å¯¹æ€§èƒ½çš„éœ€æ±‚ï¼Œæ‰€ä»¥ä½¿ç”¨å¾®æœåŠ¡å°†æ•´ä¸ªé¡¹ç›®é‡æ„

ç®€å•å°†é¡¹ç›®åˆ†ä¸ºç§’æ€æ¨¡å—å’Œotheræ¨¡å—ï¼Œotherä¸­åŒ…å«ä¸€äº›ç™»å½•å¸¸ç”¨åŠŸèƒ½ï¼Œä½¿ç”¨SpringCloudAlibaba+Nacosæ³¨å†Œä¸­å¿ƒï¼Œç½‘å…³ä½¿ç”¨gateway

# é”™è¯¯è®°å½•åŠä¼˜åŒ–

###  ä¼ å‚æœ«ä½ç²¾åº¦ä¸¢å¤±é—®é¢˜

ä¾‹å¦‚è®¢å•ID `7921756581845368832` ä¼šåœ¨jsä¸­å˜ä¸º `921756581845369000` å¯¼è‡´ç²¾åº¦ä¸¢å¤±

éƒ¨åˆ†è§£å†³æ–¹æ¡ˆè¦æ±‚æŠŠLongç±»å‹è½¬æˆStringç±»å‹è¿”å›å‰ç«¯ï¼Œè¿™ç§æ–¹æ³•ä¸€ä¸€ä¿®æ”¹å¤ªç¹ç

åˆ©ç”¨`JsonSerializer`å®Œæˆæ³¨è§£ï¼Œå®Œç¾è§£å†³Longç±»å‹ç²¾åº¦é—®é¢˜

ç»§æ‰¿JsonSerializerç±»

```java
com.fasterxml.jackson.databind.JsonSerializer;
public class JsonLongSerializer extends JsonSerializer<Long> {
    @Override
    public void serialize(Long aLong, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {
        jsonGenerator.writeString(Long.toString(aLong));
    }
}
```


æ‰¾åˆ°VOç±»ï¼Œåœ¨Longç±»å‹å­—æ®µä¸Šé¢æ·»åŠ æ³¨è§£
```java
@JsonSerialize(using = JsonLongSerializer.class )
private Long voucherId = null;
```

### SpringBootä½¿ç”¨addCorsMappingsé…ç½®è·¨åŸŸçš„é—®é¢˜

æˆ‘åœ¨é…ç½®ä¸­æ–°å»ºæ‹¦æˆªå™¨ï¼Œç”¨æ¥æ‹¦æˆªè¯·æ±‚`/admin`ä¸‹çš„è¯·æ±‚ï¼Œè¦æ±‚ç”¨æˆ·å¿…é¡»ç™»å½•åˆ‡æ˜¯ç®¡ç†å‘˜ç”¨æˆ·ï¼Œå¤§è‡´ä»£ç å¦‚ä¸‹![img](images/ç¬”è®°/28576C1.GIF)

![1583890422396](images/ç¬”è®°/1583890422396.png)

ä½¿ç”¨æ­¤æ–¹æ³•é…ç½®ä¹‹åå†ä½¿ç”¨è‡ªå®šä¹‰æ‹¦æˆªå™¨æ—¶è·¨åŸŸç›¸å…³é…ç½®å°±ä¼šå¤±æ•ˆã€‚
åŸå› æ˜¯è¯·æ±‚ç»è¿‡çš„å…ˆåé¡ºåºé—®é¢˜ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ä¼šå…ˆè¿›å…¥æ‹¦æˆªå™¨ä¸­ï¼Œè€Œä¸æ˜¯è¿›å…¥Mappingæ˜ å°„ä¸­ï¼Œæ‰€ä»¥è¿”å›çš„å¤´ä¿¡æ¯ä¸­å¹¶æ²¡æœ‰é…ç½®çš„è·¨åŸŸä¿¡æ¯ã€‚æµè§ˆå™¨å°±ä¼šæŠ¥è·¨åŸŸå¼‚å¸¸ã€‚

æ­£ç¡®çš„è§£å†³è·¨åŸŸé—®é¢˜çš„æ–¹æ³•æ—¶ä½¿ç”¨CorsFilterè¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹â†“ï¼Œä½†æ˜¯ä¹‹å‰è®¾ç½®çš„è·¨åŸŸé…ç½®å´å¤±æ•ˆäº†ï¼Œè‡ªå®šä¹‰è·¨åŸŸé…ç½®åœ¨`WebConfig.java`ä¸‹

```java
@Bean
public CorsFilter corsFilter() {
    CorsConfiguration config = new CorsConfiguration();
    // è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸå
    config.addAllowedOrigin(frontHost);
    // æ˜¯å¦å…è®¸è¯ä¹¦ ä¸å†é»˜è®¤å¼€å¯
    // config.setAllowCredentials(true);
    // è®¾ç½®å…è®¸çš„æ–¹æ³• * ä¸ºæ‰€æœ‰
    config.addAllowedMethod("*");
    // å…è®¸ä»»ä½•å¤´
    config.addAllowedHeader("*");
    //config.addExposedHeader("token");
    config.setMaxAge(3600L);
    UrlBasedCorsConfigurationSource configSource = new UrlBasedCorsConfigurationSource();
    configSource.registerCorsConfiguration("/**", config);
    return new CorsFilter(configSource);
}
```

### æ·»åŠ è®¢å•é‰´æƒ

è®¿é—®è®¢å•æ˜¯å¦ä¸ºåŒä¸€ç”¨æˆ·ï¼Œä¸æ˜¯åˆ™è¿”å›è®¢å•ä¸å­˜åœ¨(ç®¡ç†å‘˜ä¾‹å¤–)

```java
if (!orderInfo.getUserId().equals(user.getId())) {
    if (user.getRole() != AdminService.roleAdmin) {
        return Result.error(CodeMsg.ORDER_DATAILNOFOUND);
    }
}
```

### è®¾ç½®æ•°æ®åº“miaosha_goods

è®¾ç½®æ•°æ®åº“ç§’æ€å•†å“è¡¨æ’å…¥ä½¿ç”¨é»˜è®¤å½“å‰æ—¶é—´ï¼Œè¿™æ ·åª æ’å…¥ä¸€ä¸ªIDä¾¿ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€æ¡æ•°æ®

```mysql
ALTER TABLE `miaosha`.`miaosha_goods` 
MODIFY COLUMN `start_date` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP(0) COMMENT 'ç§’æ€å¼€å§‹æ—¶é—´' AFTER `stock_count`,
MODIFY COLUMN `end_date` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP(0) COMMENT 'ç§’æ€ç»“æŸæ—¶é—´' AFTER `start_date`;
# æˆ–è€…
ALTER TABLE `miaosha`.`miaosha_goods` 
MODIFY COLUMN `start_date` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'ç§’æ€å¼€å§‹æ—¶é—´' AFTER `stock_count`,
MODIFY COLUMN `end_date` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'ç§’æ€ç»“æŸæ—¶é—´' AFTER `start_date`;
```

### å‰ç«¯ä¼ å…¥æ—¥æœŸStringæ— æ³•è½¬æ¢ä¸ºDate

```java
//æ·»åŠ æ³¨è§£    
//æ­¤æ³¨è§£ä¸ºå‘å‰ç«¯ä¼ å‚@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
@DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss")
private Date endDate;
```

### ä¼ å‚æ— æ³•æ¥æ”¶é—®é¢˜

#### æ¥æ”¶å‚æ•°ä¸¤ç§å½¢å¼

è¡¨å•æ•°æ®å’Œjsonå­—ç¬¦ä¸²ï¼ˆForm Dataå’ŒRequest Payloadï¼‰

- Form Data åç«¯æ¥å—å‚æ•°ä»£ç  `@Valid LoginVo loginVo`

![1583229544766](images/ç¬”è®°/1583229544766.png)

- Jsonå­—ç¬¦ä¸²

    åç«¯æ¥å— å‚æ•°ä»£ç  `@RequestBody @Validated LoginVo loginVo`

    ![img](images/ç¬”è®°/20180817100036760.png)

- ç¤ºä¾‹

    ```java
    @PostMapping("/login")
    @ResponseBody
    public Result<String> login(@RequestBody @Validated LoginVo loginVo, HttpServletResponse response) {
        ...
        return Result.success(token);
    }
    ```

- axioså…¨å±€è®¾ç½®è¯·æ±‚æ ¼å¼ä¸ºform-data

    ```html
    import axios from 'axios'
    import qs from 'qs'
    
    // å®ä¾‹å¯¹è±¡
    let instance = axios.create({
      timeout: 6000,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    
    // è¯·æ±‚æ‹¦æˆªå™¨
    instance.interceptors.request.use(
      config => {
        config.data = qs.stringify(config.data) // è½¬ä¸ºformdataæ•°æ®æ ¼å¼
        return config
      },
      error => Promise.error(error)
    )
    ```

- æˆ–è€…

    ```html
    import axios from "axios"  //å¼•å…¥
    
    //è®¾ç½®axiosä¸ºform-data
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
    axios.defaults.headers.get['Content-Type'] = 'application/x-www-form-urlencoded';
    axios.defaults.transformRequest = [function (data) {
        let ret = ''
        for (let it in data) {
          ret += encodeURIComponent(it) + '=' + encodeURIComponent(data[it]) + '&'
        }
        return ret
    }]
    //ç„¶åå†ä¿®æ”¹åŸå‹é“¾
    Vue.prototype.$axios = axios
    
    ```

    

### é‡å¤ç§’æ€é—®é¢˜

å»ºç«‹ç´¢å¼•ä¿è¯ç”¨æˆ·å’Œå•†å“å”¯ä¸€ï¼Œé˜²æ­¢å•ä¸€ç”¨æˆ·çŸ­æ—¶é—´è¯·æ±‚Næ¬¡å¤šæ¬¡ç§’æ€åˆ°åŒä¸€å•†å“

![1583290103655](images/ç¬”è®°/1583290103655.png)





# ç§’æ€å¸¸è§é—®é¢˜

### ç§’æ€åˆ†æï¼šé«˜å¹¶å‘å‘ç”Ÿåœ¨å“ªé‡Œ

æ•°æ®åº“è®¿é—®å³°å€¼300-700ï¼Œå—æœºå™¨å½±å“;ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œæ•°æ®åº“ä¿®æ”¹åï¼Œç¼“å­˜å¹¶æ²¡ä¿®æ”¹ï¼Œè¿™æ—¶å°±éœ€è¦å®æ—¶æ›´æ–°ï¼Œå†™åˆ°ä»£ç é‡Œæœ‰è€¦åˆé—®é¢˜ã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æœºåˆ¶å»æ›´æ–°ç¼“å­˜æ•°æ®ã€‚å•ä¸ªTomcatæŠ—å‹300-500ã€‚

é¦–å…ˆæ˜¯è¯¦æƒ…é¡µï¼Œè¯¦æƒ…é¡µä¼šè·å–å½“å‰å•†å“çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œè®¡æ—¶ï¼Œæ‰§è¡Œç§’æ€æ“ä½œï¼Œè¿”å›ç»“æœï¼ˆçº¢è‰²ä»£è¡¨å¯èƒ½å‡ºç°é«˜å¹¶å‘çš„ç‚¹ï¼Œç»¿è‰²ä»£è¡¨æ— å½±å“ï¼‰

![1584373744252](images/å¼€å‘ç¬”è®°/1584373744252.png)



è¯¦æƒ…é¡µ->ç”¨æˆ·å¤§é‡åˆ·æ–°->CDNè¯¦æƒ…é¡µé™æ€åŒ–->

CDN(å†…å®¹åˆ†å‘ç½‘ç»œ)ä¸€èˆ¬éƒ¨ç½²åˆ°ç¦»ç”¨æˆ·æœ€è¿‘çš„èŠ‚ç‚¹ä¸Šï¼ŒåŠ é€Ÿç”¨æˆ·è·å–æ•°æ®ï¼Œå‘½ä¸­CDNä¸éœ€è¦è®¿é—®åç«¯æœåŠ¡å™¨ï¼Œå‰ç«¯é™æ€èµ„æºéƒ¨ç½²cdnï¼ŒåŠ¨æ€è¯¦æƒ…ä¿¡æ¯ä½¿ç”¨rediså­˜å‚¨ï¼Œåªåœ¨åˆæ¬¡è¯·æ±‚redisä¸­ä¸ºnullæ—¶å»è®¿é—®æ•°æ®åº“

ç§’æ€-> æ— æ³•ä½¿ç”¨CDNç¼“å­˜->åç«¯ç¼“å­˜å›°éš¾->ä¸€è¡Œæ•°æ®ç«äº‰ï¼šçƒ­ç‚¹å•†å“

å…¶ä»–è§£å†³æ–¹æ¡ˆï¼šåŸå­è®¡æ•°å™¨(redis/NoSQL)-->è®°å½•æ¶ˆæ¯è¡Œä¸º-->æ¶ˆè´¹æ¶ˆæ¯è½åœ°

![1584521379687](images/å¼€å‘ç¬”è®°/1584521379687.png)

ç¼ºç‚¹ï¼šå¤šæœåŠ¡å™¨éƒ¨ç½²æƒ…å†µä¸‹ï¼Œå¹‚ç­‰æ€§éš¾ä¿è¯å¯èƒ½å‡ºç°é‡å¤ç§’æ€é—®é¢˜

mysql  updateä¸€æ¡æ•°æ®å¯ä»¥è¾¾åˆ°4WQPSï¼Œå½±å“ç³»ç»Ÿé€Ÿåº¦çš„ç‚¹å¯èƒ½åœ¨javaæ§åˆ¶äº‹åŠ¡è¡Œä¸ºä¸Šã€‚

![1584523061019](images/å¼€å‘ç¬”è®°/1584523061019.png)

ç“¶é¢ˆåˆ†æ

![1584527694860](images/å¼€å‘ç¬”è®°/1584527694860.png)

ä¼˜åŒ–åˆ†æï¼šè¡Œçº§é”åœ¨Commitä¹‹åé‡Šæ”¾---ã€‹ä¼˜åŒ–æ–¹å‘å‡å°‘è¡Œçº§é”æŒæœ‰æ—¶é—´

å¤šæœºéƒ¨ç½²ä¼šæœ‰å»¶æ—¶é—®é¢˜ï¼ŒJVmä¸mysqläº¤äº’å­˜åœ¨å»¶æ—¶

![1584586745213](images/å¼€å‘ç¬”è®°/1584586745213.png)

[å¦‚ä½•æŠŠç§’æ€é€»è¾‘æ”¾åˆ°MysqlæœåŠ¡ç«¯](#å¦‚ä½•æŠŠç§’æ€é€»è¾‘æ”¾åˆ°MysqlæœåŠ¡ç«¯)





### è¶…å–é—®é¢˜

**è¶…å–**ï¼šå¤šä¸ªè¿›ç¨‹è¿›å…¥äº‹åŠ¡ï¼Œäº§ç”Ÿå…±äº«é”ï¼Œåœ¨updateåº“å­˜çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°æŸ¥è¯¢åº“å­˜éƒ½æ˜¯å¤§äº0çš„ï¼Œç»“æœä¸€å‡åº“å­˜ï¼Œå‡ºç°åº“å­˜å°äº0ï¼Œäº§ç”Ÿè¶…å–ç°è±¡

```
åœ¨sqlåŠ ä¸Šåˆ¤æ–­é˜²æ­¢æ•°æ®è¾¹ä¸ºè´Ÿæ•° 
æ•°æ®åº“åŠ å”¯ä¸€ç´¢å¼•é˜²æ­¢ç”¨æˆ·é‡å¤è´­ä¹°
redisé¢„å‡åº“å­˜å‡å°‘æ•°æ®åº“è®¿é—®ã€€å†…å­˜æ ‡è®°å‡å°‘redisè®¿é—®ã€€è¯·æ±‚å…ˆå…¥é˜Ÿåˆ—ç¼“å†²ï¼Œå¼‚æ­¥ä¸‹å•ï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒ
```

### å‰åç«¯åˆ†ç¦»

å°½é‡å‰ååˆ†ç¦»ï¼Œå‰ç«¯ä½¿ç”¨CDNåšé™æ€ç¼“å­˜

### å¯¹è±¡çº§ç¼“å­˜redis

```
 redisæ°¸ä¹…ç¼“å­˜å¯¹è±¡å‡å°‘å‹åŠ›
 redisé¢„å‡åº“å­˜å‡å°‘æ•°æ®åº“è®¿
 å†…å­˜æ ‡è®°æ–¹æ³•å‡å°‘redisè®¿é—®
```

### è®¢å•å¤„ç†é˜Ÿåˆ—rabbitmq

```
 è¯·æ±‚å…ˆå…¥é˜Ÿç¼“å†²ï¼Œå¼‚æ­¥ä¸‹å•ï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒ
 è¯·æ±‚å‡ºé˜Ÿï¼Œç”Ÿæˆè®¢å•ï¼Œå‡å°‘åº“å­˜
 å®¢æˆ·ç«¯å®šæ—¶è½®è¯¢æ£€æŸ¥æ˜¯å¦ç§’æ€æˆåŠŸ 
```

### è§£å†³åˆ†å¸ƒå¼session

```
é›ªèŠ±ç®—æ³•ç”Ÿæˆéšæœºçš„uuidä½œä¸ºcookieè¿”å›å¹¶rediså†…å­˜å†™å…¥ 
æ‹¦æˆªå™¨æ¯æ¬¡æ‹¦æˆªæ–¹æ³•ï¼Œæ¥é‡æ–°è·æ ¹æ®cookieè·å–å¯¹è±¡
ä¸‹ä¸€ä¸ªé¡µé¢æ‹¿åˆ°keyé‡æ–°è·å–å¯¹è±¡
HandlerMethodArgumentResolver æ–¹æ³• supportsParameter å¦‚æœä¸ºtrue æ‰§è¡Œ resolveArgument æ–¹æ³•è·å–miaoshauserå¯¹è±¡
å¦‚æœæœ‰ç¼“å­˜çš„è¯ è¿™ä¸ªåŠŸèƒ½å®ç°èµ·æ¥å°±å’Œç®€å•ï¼Œåœ¨ä¸€ä¸ªç”¨æˆ·è®¿é—®æ¥å£çš„æ—¶å€™æˆ‘ä»¬æŠŠè®¿é—®æ¬¡æ•°å†™åˆ°ç¼“å­˜ä¸­ï¼Œåœ¨åŠ ä¸Šä¸€ä¸ªæœ‰æ•ˆæœŸã€‚
é€šè¿‡æ‹¦æˆªå™¨. åšä¸€ä¸ªæ³¨è§£ @AccessLimit ç„¶åå°è£…è¿™ä¸ªæ³¨è§£ï¼Œå¯ä»¥æœ‰æ•ˆçš„è®¾ç½®æ¯æ¬¡è®¿é—®å¤šå°‘æ¬¡ï¼Œæœ‰æ•ˆæ—¶é—´æ˜¯å¦éœ€è¦ç™»å½•ï¼

-- å¯ä»¥åšJWTéªŒè¯ç³»ç»Ÿï¼Œæ— éœ€å­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œè¿‡æœŸæ—¶é—´ä½¿ç”¨cookieç®¡ç†
```

### é€šç”¨ç¼“å­˜keyçš„å°è£…é‡‡ç”¨ä»€ä¹ˆè®¾è®¡æ¨¡å¼

```
æ¨¡æ¿æ¨¡å¼çš„ä¼˜ç‚¹
å…·ä½“ç»†èŠ‚æ­¥éª¤å®ç°å®šä¹‰åœ¨å­ç±»ä¸­ï¼Œå­ç±»å®šä¹‰è¯¦ç»†å¤„ç†ç®—æ³•æ˜¯ä¸ä¼šæ”¹å˜ç®—æ³•æ•´ä½“ç»“æ„
ä»£ç å¤ç”¨çš„åŸºæœ¬æŠ€æœ¯ï¼Œåœ¨æ•°æ®åº“è®¾è®¡ä¸­å°¤ä¸ºé‡è¦
å­˜åœ¨ä¸€ç§åå‘çš„æ§åˆ¶ç»“æ„ï¼Œé€šè¿‡ä¸€ä¸ªçˆ¶ç±»è°ƒç”¨å…¶å­ç±»çš„æ“ä½œï¼Œé€šè¿‡å­ç±»å¯¹çˆ¶ç±»è¿›è¡Œæ‰©å±•å¢åŠ æ–°çš„è¡Œä¸ºï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€
ç¼ºç‚¹ï¼šã€€æ¯ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œä¼šå¯¼è‡´ç±»çš„ä¸ªæ•°å¢åŠ ï¼Œç³»ç»Ÿæ›´åŠ åºå¤§
```

### redisçš„åº“å­˜å¦‚ä½•ä¸æ•°æ®åº“çš„åº“å­˜ä¿æŒä¸€è‡´

```
redisçš„æ•°é‡ä¸æ˜¯åº“å­˜,ä»–çš„ä½œç”¨ä»…ä»…åªæ˜¯ä¸ºäº†é˜»æŒ¡å¤šä½™çš„è¯·æ±‚é€ç©¿åˆ°DBï¼Œèµ·åˆ°ä¸€ä¸ªä¿æŠ¤çš„ä½œç”¨
å› ä¸ºç§’æ€çš„å•†å“æœ‰é™ï¼Œæ¯”å¦‚10ä¸ªï¼Œè®©1ä¸‡ä¸ªè¯·æ±‚åŒºè®¿é—®DBæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºæœ€å¤šä¹Ÿå°±åªèƒ½10ä¸ª
è¯·æ±‚ä¸‹å•æˆåŠŸï¼Œæ‰€æœ‰è¿™ä¸ªæ˜¯ä¸€ä¸ªä¼ªå‘½é¢˜ï¼Œæˆ‘ä»¬æ˜¯ä¸éœ€è¦ä¿æŒä¸€è‡´çš„
```

### redis é¢„å‡æˆåŠŸï¼ŒDBæ‰£å‡åº“å­˜å¤±è´¥è§£å†³æ–¹æ¡ˆ

```
-å…¶å®æˆ‘ä»¬å¯ä»¥ä¸ç”¨å¤ªåœ¨æ„ï¼Œå¯¹ç”¨æˆ·è€Œè¨€ï¼Œç§’æ€ä¸ä¸­æ˜¯æ­£å¸¸ç°è±¡ï¼Œç§’æ€ä¸­æ‰æ˜¯æ„å¤–ï¼Œå•ä¸ªç”¨æˆ·ç§’æ€ä¸­
1.æœ¬æ¥å°±æ˜¯å°æ¦‚ç‡äº‹ä»¶ï¼Œå‡ºç°è¿™ç§æƒ…å†µå¯¹äºç”¨æˆ·è€Œè¨€æ²¡æœ‰ä»»ä½•å½±å“
2.å¯¹äºå•†æˆ·è€Œè¨€ï¼Œæœ¬æ¥å°±æ˜¯ä¸ºäº†æ´»åŠ¨æ‹‰æµé‡äººæ°”çš„ï¼Œå–ä¸å®Œè¿˜å¯ä»¥çœä¸€éƒ¨åˆ†è´¹ç”¨ï¼Œä½†æ˜¯æ´»åŠ¨è¿˜å‚ä¸äº†ï¼Œä¹Ÿå°±æ²¡æœ‰äº†ä»»ä½•å½±å“
3.å¯¹ç½‘ç«™è€Œè¨€ï¼Œæœ€é‡è¦çš„æ˜¯ä½“éªŒï¼Œåªè¦ç½‘ç«™ä¸å´©æºƒï¼Œå¯¹ç”¨æˆ·è€Œè¨€æ²¡æœ‰ä»»ä½•å½±å“
```

### Redisåºåˆ—åŒ–è§£å†³æ–¹æ¡ˆ

åºåˆ—åŒ–å¯ä»¥é‡‡ç”¨å­—ç¬¦ä¸²æ–¹å¼ä»¥jsonæ•°æ®å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨ï¼Œä»¥jsonå­˜å‚¨æœ‰åˆ©äºæŸ¥çœ‹å­˜å‚¨çš„æ•°æ®ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨å°†æœ‰æ›´å¿«çš„é€Ÿåº¦ï¼Œä»¥åŠæ›´èŠ‚çœRedisç©ºé—´ï¼Œæœ¬æ¬¡å¼€å‘é‡‡ç”¨ä¸¤ç§è§£å†³æ–¹æ¡ˆå¹¶å­˜çš„æ–¹å¼ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åšåˆ°å¿«æ·åˆ‡æ¢

 æ€§èƒ½å¯¹æ¯”æµ‹è¯• https://github.com/eishay/jvm-serializers/wiki

### rabbitmqå¦‚ä½•åšåˆ°æ¶ˆæ¯ä¸é‡å¤ä¸ä¸¢å¤±å³ä½¿æœåŠ¡å™¨é‡å¯

 - æŒä¹…åŒ–äº¤æ¢æœºå’Œé˜Ÿåˆ—

 - æŒä¹…åŒ–æ¶ˆæ¯

     [å¦‚ä½•ä¿è¯RabbitMQçš„æ¶ˆæ¯ä¸ä¸¢å¤±åŠå…¶èƒŒåçš„åŸç†](https://www.cnblogs.com/tiancai/p/9627138.html)      https://www.cnblogs.com/tiancai/p/9627138.html

    > **è™½ç„¶æŒä¹…åŒ–æ¶ˆæ¯å¯ä»¥åšåˆ°æ¶ˆæ¯çš„ä¸ä¸¢å¤±ï¼Œä½†æŒä¹…åŒ–çš„æ¶ˆæ¯åœ¨è¿›å…¥é˜Ÿåˆ—å‰ä¼šè¢«å†™åˆ°ç£ç›˜ï¼Œè¿™ä¸ªè¿‡ç¨‹æ¯”å†™åˆ°å†…å­˜æ…¢å¾—å¤šï¼Œæ‰€ä»¥ä¼šä¸¥é‡çš„å½±å“æ€§èƒ½ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯çš„ååé‡é™ä½10å€ä¸æ­¢ã€‚æ‰€ä»¥ï¼Œåœ¨åšæ¶ˆæ¯æŒä¹…åŒ–å‰ï¼Œä¸€å®šè¦è®¤çœŸè€ƒè™‘æ€§èƒ½å’Œéœ€æ±‚ä¹‹é—´çš„å¹³è¡¡å…³ç³»ã€‚**

### ä¸ºä»€ä¹ˆthreadlocalå­˜å‚¨userå¯¹è±¡ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ

```html
å¹¶å‘ç¼–ç¨‹ä¸­é‡è¦çš„é—®é¢˜å°±æ˜¯æ•°æ®å…±äº«ï¼Œå½“ä½ åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ”¹å˜ä»»æ„å±æ€§æ—¶ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šå› æ­¤å—åˆ°å½±å“ï¼ŒåŒæ—¶ä¼šçœ‹åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹åçš„å€¼
æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›å¦‚æ­¤ï¼Œæ¯”å¦‚ï¼šå¤šä¸ªçº¿ç¨‹å¢å¤§æˆ–å‡å°åŒä¸€ä¸ªè®¡æ•°å™¨å˜é‡
ä½†æ˜¯ï¼Œæœ‰æ—¶æˆ‘ä»¬å¸Œæœ›ç¡®ä¿æ¯ä¸ªçº¿ç¨‹ï¼Œåªèƒ½å·¥ä½œåœ¨å®ƒè‡ªå·± çš„çº¿ç¨‹å®ä¾‹çš„æ‹·è´ä¸Šï¼ŒåŒæ—¶ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ•°æ®

ä¸¾ä¾‹ï¼š ä¸¾ä¸ªä¾‹å­ï¼Œæƒ³è±¡ä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå­å•†åŠ¡åº”ç”¨ï¼Œä½ éœ€è¦ä¸ºæ¯ä¸€ä¸ªæ§åˆ¶å™¨å¤„ç†çš„é¡¾å®¢è¯·æ±‚ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼ŒåŒæ—¶å°†å…¶ä¼ åˆ°ç®¡ç†å™¨æˆ–DAOçš„ä¸šåŠ¡æ–¹æ³•ä¸­ï¼Œä»¥ä¾¿è®°å½•æ—¥å¿—ã€‚ä¸€ç§æ–¹æ¡ˆæ˜¯å°†äº‹åŠ¡IDä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œä¼ åˆ°æ‰€æœ‰çš„ä¸šåŠ¡æ–¹æ³•ä¸­ã€‚ä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆï¼Œå®ƒä¼šä½¿ä»£ç å˜å¾—å†—ä½™ã€‚ä½ å¯ä»¥ä½¿ç”¨ThreadLocalç±»å‹çš„å˜é‡è§£å†³è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆåœ¨æ§åˆ¶å™¨æˆ–è€…ä»»æ„ä¸€ä¸ªé¢„å¤„ç†å™¨æ‹¦æˆªå™¨ä¸­ç”Ÿæˆä¸€ä¸ªäº‹åŠ¡IDç„¶ååœ¨ThreadLocalä¸­è®¾ç½®äº‹åŠ¡IDï¼Œæœ€åï¼Œä¸è®ºè¿™ä¸ªæ§åˆ¶å™¨è°ƒç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œéƒ½èƒ½ä»threadlocalä¸­è·å–äº‹åŠ¡IDè€Œä¸”è¿™ä¸ªåº”ç”¨çš„æ§åˆ¶å™¨å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ŒåŒæ—¶åœ¨æ¡†æ¶ å±‚é¢ï¼Œå› ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­å¤„ç†çš„ï¼Œæ‰€ä»¥äº‹åŠ¡IDå¯¹äºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯å”¯ä¸€çš„ï¼Œè€Œä¸”å¯ä»¥ä»æ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œè·¯å¾„è·å–è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºæ¯ä¸ªçº¿ç¨‹éƒ½åœ¨ç»´æŠ¤è‡ªå·±çš„å˜é‡ï¼š
 Starting Thread: 0 : Fri Sep 21 23:05:34 CST 2018
 Starting Thread: 2 : Fri Sep 21 23:05:34 CST 2018
 Starting Thread: 1 : Fri Jan 02 05:36:17 CST 1970
 Thread Finished: 1 : Fri Jan 02 05:36:17 CST 1970
 Thread Finished: 0 : Fri Sep 21 23:05:34 CST 2018
 Thread Finished: 2 : Fri Sep 21 23:05:34 CST 2018
 
 å±€éƒ¨çº¿ç¨‹é€šå¸¸ä½¿ç”¨åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå½“ä½ æœ‰ä¸€äº›å¯¹è±¡å¹¶ä¸æ»¡è¶³çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯ä½ æƒ³é¿å…åœ¨ä½¿ç”¨synchronizedå…³é”®å­—
 å—æ—¶äº§ç”Ÿçš„åŒæ­¥è®¿é—®ï¼Œé‚£ä¹ˆï¼Œè®©æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å®ƒè‡ªå·±çš„å¯¹è±¡å®ä¾‹
 æ³¨æ„ï¼šå±€éƒ¨å˜é‡æ˜¯åŒæ­¥æˆ–å±€éƒ¨çº¿ç¨‹çš„ä¸€ä¸ªå¥½çš„æ›¿ä»£ï¼Œå®ƒæ€»æ˜¯èƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å”¯ä¸€å¯èƒ½é™åˆ¶ä½ è¿™æ ·åšçš„æ˜¯ä½ çš„åº”ç”¨è®¾è®¡çº¦æŸ
 æ‰€ä»¥è®¾è®¡threadlocalå­˜å‚¨userä¸ä¼šå¯¹å¯¹è±¡äº§ç”Ÿå½±å“ï¼Œæ¯æ¬¡è¿›æ¥ä¸€ä¸ªè¯·æ±‚éƒ½ä¼šäº§ç”Ÿè‡ªèº«çš„çº¿ç¨‹å˜é‡æ¥å­˜å‚¨
```

åŒæ—¶ä½ éœ€è¦æ³¨æ„çš„æ˜¯åŠæ—¶é‡Šæ”¾è¢«å­˜å‚¨çš„æ•°æ®ï¼Œå¯ä»¥åœ¨æœ€åçš„getååŠ ä¸Šremove

### redis åˆ†å¸ƒå¼é”å®ç°æ–¹æ³•

V1---->>ç‰ˆæœ¬æ²¡æœ‰æ“ä½œï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼šé€ æˆåŒä¸€æ—¶é—´ï¼Œèµ„æºæµªè´¹è€Œä¸”å¾ˆå®¹æ˜“å‡ºç°å¹¶å‘é—®é¢˜

V2---->>é‡‡ç”¨æˆç†Ÿçš„æ¡†æ¶redisson,å°è£…å¥½çš„æ–¹æ³•åˆ™å¯ä»¥ç›´æ¥å¤„ç†ï¼Œä½†æ˜¯waittimeè®°ä½è¦è¿™åªä¸º0

### sqlä¼˜åŒ–()

éƒ½è¯´mysqlçš„æ•ˆç‡ä½ï¼Œå…¶å®å¹¶ä¸æ˜¯ã€‚ä¸€æ¡updateè¯­å¥1ç§’å¯ä»¥æŠ—ä½4Wçš„å¹¶å‘ï¼Œè¿™å…¶å®ä¸ç®—ä½äº†ï¼›é‚£ä¹ˆæ•ˆç‡æ˜¯ä¸¢åœ¨äº†å“ªé‡Œå‘¢ï¼Ÿ

GCï¼šå°±æ˜¯javaè™šæ‹Ÿæœºå›æ”¶åƒåœ¾ï¼Œé‡Šæ”¾å†…å­˜çš„è¿‡ç¨‹ã€‚è¿™ä¼šç»ˆç«¯æ‰€ç”¨çš„ä¸šåŠ¡ï¼Œä¹Ÿå°±æ˜¯javaä»£ç ï¼Œå¤§æ¦‚éœ€è¦å‡ åæ¯«ç§’ã€‚ä¸æ˜¯æ¯æ¬¡æ“ä½œéƒ½ä¼šæœ‰GCäº§ç”Ÿï¼Œä½†å®ƒä¸€å®šä¼šå‘ç”Ÿã€‚

è¿™é‡Œè¿˜ä¼šæœ‰ä¸€ä¸ªäº‹åŠ¡çš„è¡Œçº§é”çš„é—®é¢˜ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šæŠŠç›¸å…³çš„åŠŸèƒ½é”ä½ã€‚å½“å®ƒcommitæˆ–è€…rollbackä¹‹åï¼Œåé¢çš„äº‹åŠ¡æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œä»¥æ¬¡ç±»æ¨ï¼Œä¼šé€ æˆå¾ˆå¤§çš„æ‹¥å µã€‚

ä¼˜åŒ–çš„æ–¹å‘ï¼šå‡å°‘è¡Œçº§é”æŒæœ‰çš„æ—¶é—´ã€‚

è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼šå¦‚ä½•å‡å°‘è¡Œçº§é”æŒæœ‰æ—¶é—´

    ä»¥ç§’æ€ç³»ç»Ÿä¸ºä¾‹ï¼šå…ˆæ‰§è¡Œinsertï¼Œåæ‰§è¡Œupdateï¼Œè¡Œçº§é”æŒæœ‰æ—¶é—´åªåœ¨updateå‰åï¼›
    è‹¥å…ˆæ‰§è¡Œupdateï¼Œåœ¨æ‰§è¡Œinsertï¼Œé‚£ä¹ˆè¡Œçº§é”çš„æŒæœ‰æ—¶é—´å°±å˜æˆäº†updateåˆ°ç¬¬äºŒä¸ªupdateä¹‹é—´çš„updateå’Œinsertæ—¶é—´ï¼Œç›¸å½“äºå¤šåŒ…å«äº†insertçš„ç½‘ç»œå»¶è¿Ÿå’ŒGCã€‚
    åŒä¸€äº‹åŠ¡ï¼Œå…ˆåé¡ºåºç¡®å®æœ‰å·®å¼‚ï¼ˆè¿˜æŒºå¤§ï¼‰ã€‚

   æŠŠå®¢æˆ·ç«¯é€»è¾‘æ”¾åˆ°MysqlæœåŠ¡ç«¯ï¼Œé¿å…ç½‘ç»œå»¶è¿Ÿå’ŒGCçš„å½±å“ï¼›

ç§’æ€ç¯èŠ‚çš„ç“¶é¢ˆç‚¹åœ¨å¯¹åŒä¸€å•†å“â€œç«äº‰â€æ‰§è¡Œ update æ“ä½œï¼Œæ•°æ®åº“å¯¹ä¸€è¡Œæ•°æ®æ‰§è¡Œ updateæ“ä½œæ—¶ï¼Œä¼šåŠ ä¸Šè¡Œçº§é”ï¼Œæ­¤æ—¶å…¶ä»– update æ“ä½œå¤„äºç­‰å¾…ï¼Œç­‰äº‹åŠ¡æäº¤æˆ–å›æ»šåé‡Šæ”¾è¡Œçº§é”ï¼Œå…¶ä»– update æ“ä½œæ‰èƒ½ä¾æ¬¡æ‰§è¡Œï¼Œè€Œ insert æ“ä½œæ˜¯å¯ä»¥å¹¶å‘è¿è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¡Œçº§é”æŒæœ‰æ—¶é—´é˜»å¡äº†ç§’æ€è¿›ç¨‹ï¼›Java ä¸ MySQL äº¤äº’ï¼Œä½¿ç”¨ Java æ‰§è¡Œ SQL è¯­å¥çš„è€—æ—¶ï¼ŒåŒ…æ‹¬ SQL è¯­å¥æ‰§è¡Œè€—æ—¶ã€å‘é€è¯­å¥åˆ° MySQL å’Œè¿”å›ç»“æœçš„ç½‘ç»œå»¶è¿Ÿã€GC æ“ä½œè€—æ—¶ï¼Œä¸€æ¬¡ç§’æ€è¡Œä¸ºçš„è€—æ—¶è®¡ç®—å…¬å¼ä¸ºï¼šä¸€æ¬¡ç§’æ€è€—æ—¶=update è€—æ—¶+insert è€—æ—¶+ç½‘ç»œå»¶è¿Ÿ+GC è€—æ—¶+å…¶ä»–è€—æ—¶ã€‚æ‰€æœ‰è€—æ—¶åŠ èµ·æ¥ï¼Œç§’æ€è¡Œä¸ºçš„æ€»è€—æ—¶å°±å˜é•¿äº†

å› æ­¤å‡å°‘è¡Œçº§é”çš„æŒæœ‰æ—¶é—´å’Œé™ä½ç½‘ç»œå»¶è¿Ÿå³å¯å¤§å¹…é™ä½ä¸€æ¬¡ç§’æ€è€—æ—¶ï¼Œæ–¹æ³•æ˜¯ï¼šâ‘ å°† insert è°ƒåˆ° upâƒdate ä¹‹å‰è¿è¡Œï¼Œinsert å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œè‹¥ update æˆåŠŸï¼Œåˆ™å¯ä»¥åŒæ—¶æäº¤ï¼Œå¦åˆ™ï¼Œåˆ™åŒæ—¶å›æ»šï¼Œåªæœ‰ update éœ€è¦é”ä½ï¼Œæ€§èƒ½æå‡ä¸€å€ï¼›â‘¡å°†ä¸šåŠ¡é€»è¾‘å°è£…æˆå­˜å‚¨è¿‡ç¨‹æ”¾åœ¨MySQL æœåŠ¡ç«¯è¿è¡Œï¼ŒJava å®¢æˆ·ç«¯åªéœ€è¦æ‹¿åˆ°æ‰§è¡Œç»“æœå³å¯ï¼ŒMySQL æœ¬åœ°æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹æ˜¯å¾ˆå¿«çš„ï¼Œè¿™æ ·å¤§éƒ¨åˆ†ç½‘ç»œå»¶è¿Ÿå’Œ GC è€—æ—¶ä¼šè¢«æ¶ˆç­æ‰

- å­˜å‚¨è¿‡ç¨‹

```mysql
-- ç§’æ€æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹
-- ;åˆ†å·å†³å®šæ˜¯å¦æ¢è¡Œ
DELIMITER $$ -- æ–°çš„æ¢è¡Œ ç”± ; è½¬æ¢ä¸º $$
-- å®šä¹‰å­˜å‚¨è¿‡ç¨‹ in è¾“å…¥å‚æ•° out è¾“å‡ºå‚æ•°
-- row_count() è¿”å›ä¸Šä¸€æ¡ä¿®æ”¹ç±»å‹sql (delete, insert, update)çš„å½±å“è¡Œæ•°çš„å½±å“å‡½æ•°
-- row_count() 0è¡¨ç¤ºæœªä¿®æ”¹æ•°æ® >0 è¡¨ç¤ºä¿®æ”¹çš„è¡Œæ•° <0è¡¨ç¤ºsqlé”™è¯¯/æœªæ‰§è¡Œ
create procedure `miaosha`.`execute_miaosha`(in v_userId bigint, in v_goodsId bigint,
                                             in v_orderId bigint, out r_result int)
begin
    declare insert_count int default 0;
    start transaction ;
    -- å¼€å§‹äº‹åŠ¡
    -- æ’å…¥è®¢å•
    insert ignore into miaosha_order
        (user_id, goods_id, order_id)
    values (v_userId, v_goodsId, v_orderId);
    select row_count() into insert_count;
    if (insert_count = 0) then -- æœªä¿®æ”¹
        rollback;
        set r_result = -1; -- è¿”å›é‡å¤ç§’æ€
    elseif (insert_count < 0) then -- æ²¡æœ‰æ‰§è¡Œè¿‡æˆ–è€…é”™è¯¯
        rollback;
        set r_result = -2; -- è¿”å›ç³»ç»Ÿå¼‚å¸¸
    else
        update miaosha_goods m,goods g
        set m.stock_count = m.stock_count - 1,
            g.goods_stock = g.goods_stock - 1
        where m.goods_id = g.id
          and m.goods_id = v_goodsId
          and m.stock_count > 0; -- åŒæ—¶æ›´æ–°ä¸¤ä¸ªåº“å­˜
        select ROW_COUNT() INTO insert_count;
        if (insert_count = 0) then
            rollback;
            SET r_result = 0;
        elseif (insert_count < 0) then
            rollback;
            set r_result = -2;
        else
            commit; -- æäº¤
            set r_result = 1; -- è¿”å›æˆåŠŸ
        end if;
    end if;
end $$
-- å­˜å‚¨è¿‡ç¨‹å®šä¹‰ç»“æŸ

-- ä½¿ç”¨
set @r_result = 0;
call execute_miaosha(15588537323, 7921356129305198597, 1008600, @r_result)
select @r_result
```



ç»è¿‡å¤šç»„æµ‹è¯•ï¼Œå¯¹åŒä¸€è¡Œæ•°æ®æ‰§è¡Œä¸€æ¬¡ update æ“ä½œï¼Œä½¿ç”¨å­˜å‚¨è¿‡ç¨‹äº‹åŠ¡çš„è¡Œçº§é”æŒæœ‰æ—¶é—´å¤§çº¦ä¸º 6msï¼Œä½¿ç”¨ Java å®¢æˆ·ç«¯æ‰˜ç®¡çš„äº‹åŠ¡è¡Œçº§é”æŒæœ‰æ—¶é—´å¤§çº¦ä¸º40msï¼Œç›¸å·® 34msï¼Œè¿™æ„å‘³è€…å¦‚æœæœ‰ 500 äººåŒæ—¶ç«äº‰åŒä¸€ä¸ªçƒ­ç‚¹å•†å“ï¼Œä¼˜åŒ–åçš„äº‹åŠ¡æ’é˜Ÿæ—¶é—´å¯ä»¥å‡å°‘ 17s

![1584281131021](images/å¼€å‘ç¬”è®°/1584281131021.png)



![æ•´ä½“æµç¨‹](images/å¼€å‘ç¬”è®°/MySQLGood.png)

QPSæµ‹è¯•ï¼Œæœªä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å‰ï¼Œ

- ç§’æ€å•†å“1ï¼Œç§’æ€æ•°é‡10ï¼Œçº¿ç¨‹æ•°5000ï¼Œå¾ªç¯æ¬¡æ•°3æ¬¡(æ­¤æ—¶Tomcaté€šè¿‡è°ƒæ•´æœ€å¤§å¹¶å‘é‡ï¼Œå¼‚å¸¸ç‡å¤§å¹…ä¸‹é™ï¼Œæœªå‡ºç°è¶…å–é—®é¢˜)

- ç»“æœï¼šQPS/1175![1584686991493](images/å¼€å‘ç¬”è®°/1584686991493.png)

QPSæµ‹è¯•ï¼Œä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å

- è¿™ä¸€æªæ–½å°†å¤§å¹…å‡å°‘æ•°æ®åº“ä¸jvmäº¤äº’ï¼ˆç”±äºä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæµ‹è¯•æ•°æ®é‡è¾ƒå°‘æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼‰

- å‹æµ‹æ¡ä»¶å¦‚ä¸Š QPS/1368

    ![1584704774188](images/å¼€å‘ç¬”è®°/1584704774188.png)

### éœ€è¦ä»æœåŠ¡å™¨è¯·æ±‚æ—¶é—´ï¼Œä¿è¯æ—¶é—´ä¸€è‡´æ€§å—ï¼Ÿ

è¯·æ±‚è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œä¼šä»æœåŠ¡å™¨æºå¸¦è¯·æ±‚å‰©ä½™æ—¶é—´ï¼Œæ ¹æ®æ­¤æ—¶é—´å€’è®¡æ—¶ï¼Œæ‰€ä»¥ä¸éœ€è¦ä»æœåŠ¡å™¨è¯·æ±‚æ—¶é—´

### çƒ­ç‚¹æ•°æ®Rediså‡»ç©¿ï¼Œé›ªå´©é—®é¢˜

[Redisç¼“å­˜å‡»ç©¿ï¼Œç©¿é€ï¼Œé›ªå´©ç­‰é—®é¢˜ï¼ŒåŠè§£å†³æ–¹æ¡ˆ](./Redisç¼“å­˜å‡»ç©¿ï¼Œç©¿é€ï¼Œé›ªå´©ç­‰é—®é¢˜ï¼ŒåŠè§£å†³æ–¹æ¡ˆ.md)

```java
//é˜²æ­¢ç¼“å­˜é›ªå´©ï¼Œéšæœºæ—¶é—´å­˜å‚¨
this.expireSeconds = expireSeconds + (int) (Math.random() * 11 + 40);
```

###  å¦‚æœç”¨æˆ·ä¸åœåœ°æŸ¥è¯¢ä¸€æ¡ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ²¡æœ‰ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šå‡ºç°ä»€ä¹ˆ

å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œç¼“å­˜ä¸­æ²¡æœ‰ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œå½“ç„¶å¦‚æœä¸è®¾ç½®åˆ¤æ–­ï¼Œä¼šä¸€ç›´è°ƒç”¨æ•°æ®åº“ï¼Œä½¿æ•°æ®åº“æ•ˆç‡é™ä½ï¼Œè®¿é—®é‡å¤§æ—¶ç”šè‡³ä¼šå®•æœºã€‚

è§£å†³æ–¹æ¡ˆï¼šä»æ•°æ®åº“æŸ¥è¯¢ï¼Œå¦‚æœæ•°æ®åº“æ²¡æœ‰ï¼Œåˆ™è¿”å›å€¼ä¸ºNullï¼Œåˆ¤æ–­æ•°æ®åº“è¿”å›çš„å€¼ï¼Œå¦‚æœä¸ºNullï¼Œåˆ™è‡ªå®šä¹‰æŠŠæ ‡è¯†çš„å­—æ®µå­˜åˆ°Redisä¸­ï¼Œç”¨key,valueçš„æ–¹æ³•ï¼Œjedis.setex(key,"empty")ï¼Œè®¾ç½®å¤±æ•ˆæ—¶é—´è·Ÿå…·ä½“æƒ…å†µè€Œå®šï¼Œç„¶åè°ƒç”¨String json=jedis.get(key),åˆ¤æ–­æ˜¯å¦è·å–çš„å€¼"empty".equal(json),å¦‚æœç›¸ç­‰ï¼Œåˆ™æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œç»™ç”¨æˆ·æç¤ºï¼Œæˆ–è€…ç›´æ¥return nullã€‚è¿™æ ·ç”¨æˆ·å†æ¬¡æŸ¥è¯¢çš„æ—¶å€™ç”±äºå…ˆä»reidsç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œredisä¼šæœ‰å¯¹åº”çš„Keyè·å–ä¹‹å‰è®¾ç½®çš„valueå€¼ï¼Œè¿™æ ·å°±ä¸ä¼šå†æ¬¡è°ƒç”¨æ•°æ®åº“ï¼Œå½±å“æ•ˆç‡ç­‰é—®é¢˜ã€‚

### mybatisæŸ¥è¯¢æ€§èƒ½æå‡

 resultTypeæ”¹ç”¨resultMapï¼Œå¤§æ•°æ®æŸ¥è¯¢æ—¶æ€§èƒ½æ˜¾è‘—æå‡

### åŸºäºTomcatè¿æ¥çš„è°ƒä¼˜

```properties
# æœ€å¤§çº¿ç¨‹æ•°
server.tomcat.max-threads=500
# é˜Ÿåˆ—é•¿åº¦
server.tomcat.accept-count=50
# æœ€å¤§é“¾æ¥æ•°
server.tomcat.max-connections=5000
```

### å¦‚ä½•åˆ¤æ–­Updateæ›´æ–°æˆåŠŸ

- ä¸¤ä¸ªæ¡ä»¶
    - Updateè‡ªèº«æ²¡æŠ¥é”™
    - å®¢æˆ·ç«¯ç¡®è®¤Updateå½±å“è®°å½•æ•°
- ä¼˜åŒ–æ€è·¯
    - æŠŠå®¢æˆ·ç«¯é€»è¾‘æ”¾åˆ°MySQLæœåŠ¡ç«¯ï¼Œé¿å…ç½‘ç»œå»¶è¿Ÿå’ŒGCå½±å“

### <span id="å¦‚ä½•æŠŠç§’æ€é€»è¾‘æ”¾åˆ°MysqlæœåŠ¡ç«¯">å¦‚ä½•æŠŠç§’æ€é€»è¾‘æ”¾åˆ°MysqlæœåŠ¡ç«¯</span>

ä¸¤ç§è§£å†³æ–¹æ¡ˆ:

- å®šåˆ¶SQLæ–¹æ¡ˆ:update /*+ [auto_ _commit] */ï¼Œéœ€è¦ä¿®æ”¹MySQLæºç .
- ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹:æ•´ä¸ªäº‹åŠ¡åœ¨MySQLç«¯å®Œæˆ.











ç³»ç»Ÿæ¶æ„è®¾è®¡åœ¨æ•´ä¸ªç³»ç»Ÿçš„å¼€å‘ä¸­èµ·ç€é‡è¦ä½œç”¨ï¼Œå®ƒæè¿°ç³»ç»Ÿè¦ç´ ä¹‹é—´çš„å…³ç³»ï¼ŒæœåŠ¡äºæ•´ä¸ªå¼€å‘è¿‡ç¨‹ã€‚å¥½çš„æ¶æ„è®¾è®¡å¯ä»¥ä¸ºå¼€å‘æŒ‡æ˜æ–¹å‘ï¼Œå‡å°‘å¼€å‘å‘¨æœŸï¼Œé™ä½è¿ç»´æˆæœ¬ï¼Œæœ‰åˆ©äºåæœŸç»´æŠ¤ã€‚å•ä½“æ¶æ„æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼šå•ä½“æ¶æ„çš„ä¼˜ç‚¹:æ¶æ„å•ä¸€,å®¹æ˜“ç»´æŠ¤å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²éƒ½æ¯”è¾ƒä¾¿æ·ï¼Œä½†å…¶ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå•ä½“æ¶æ„çš„ç¼ºç‚¹ï¼šå¤æ‚åº¦é«˜ã€éƒ¨ç½²æ…¢ï¼Œè€Œä¸”ä½“ç§¯å¾ˆå¤§ï¼Œä¸åˆ©äºå‘å¸ƒã€å ç”¨æœåŠ¡å™¨èµ„æºè¿‡å¤§ã€ä¸åˆ©äºçƒ­ç‚¹æ•°æ®çš„åˆ†å‰²ã€‚